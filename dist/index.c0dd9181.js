function t(t){let e=t[0],i=t[1],s=t[2];return Math.sqrt(e*e+i*i+s*s)}function e(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function i(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t}function s(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function r(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function n(t){let e=t[0],i=t[1],s=t[2];return e*e+i*i+s*s}function a(t,e){let i=e[0],s=e[1],r=e[2],n=i*i+s*s+r*r;return n>0&&(n=1/Math.sqrt(n)),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function h(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function o(t,e,i){let s=e[0],r=e[1],n=e[2],a=i[0],h=i[1],o=i[2];return t[0]=r*o-n*h,t[1]=n*a-s*o,t[2]=s*h-r*a,t}const l=function(){const t=[0,0,0],i=[0,0,0];return function(s,r){e(t,s),e(i,r),a(t,t),a(i,i);let n=h(t,i);return n>1?0:n<-1?Math.PI:Math.acos(n)}}();class u extends Array{constructor(t=0,e=t,i=t){return super(t,e,i),this}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(t){this[0]=t}set y(t){this[1]=t}set z(t){this[2]=t}set(t,e=t,i=t){return t.length?this.copy(t):(function(t,e,i,s){t[0]=e,t[1]=i,t[2]=s}(this,t,e,i),this)}copy(t){return e(this,t),this}add(t,e){return e?i(this,t,e):i(this,this,t),this}sub(t,e){return e?s(this,t,e):s(this,this,t),this}multiply(t){var e,i,s;return t.length?(i=this,s=t,(e=this)[0]=i[0]*s[0],e[1]=i[1]*s[1],e[2]=i[2]*s[2]):r(this,this,t),this}divide(t){var e,i,s;return t.length?(i=this,s=t,(e=this)[0]=i[0]/s[0],e[1]=i[1]/s[1],e[2]=i[2]/s[2]):r(this,this,1/t),this}inverse(t=this){var e,i;return i=t,(e=this)[0]=1/i[0],e[1]=1/i[1],e[2]=1/i[2],this}len(){return t(this)}distance(e){return e?function(t,e){let i=e[0]-t[0],s=e[1]-t[1],r=e[2]-t[2];return Math.sqrt(i*i+s*s+r*r)}(this,e):t(this)}squaredLen(){return n(this)}squaredDistance(t){return t?function(t,e){let i=e[0]-t[0],s=e[1]-t[1],r=e[2]-t[2];return i*i+s*s+r*r}(this,t):n(this)}negate(t=this){var e,i;return i=t,(e=this)[0]=-i[0],e[1]=-i[1],e[2]=-i[2],this}cross(t,e){return e?o(this,t,e):o(this,this,t),this}scale(t){return r(this,this,t),this}normalize(){return a(this,this),this}dot(t){return h(this,t)}equals(t){return i=t,(e=this)[0]===i[0]&&e[1]===i[1]&&e[2]===i[2];var e,i}applyMatrix3(t){return function(t,e,i){let s=e[0],r=e[1],n=e[2];t[0]=s*i[0]+r*i[3]+n*i[6],t[1]=s*i[1]+r*i[4]+n*i[7],t[2]=s*i[2]+r*i[5]+n*i[8]}(this,this,t),this}applyMatrix4(t){return function(t,e,i){let s=e[0],r=e[1],n=e[2],a=i[3]*s+i[7]*r+i[11]*n+i[15];a=a||1,t[0]=(i[0]*s+i[4]*r+i[8]*n+i[12])/a,t[1]=(i[1]*s+i[5]*r+i[9]*n+i[13])/a,t[2]=(i[2]*s+i[6]*r+i[10]*n+i[14])/a}(this,this,t),this}scaleRotateMatrix4(t){return function(t,e,i){let s=e[0],r=e[1],n=e[2],a=i[3]*s+i[7]*r+i[11]*n+i[15];a=a||1,t[0]=(i[0]*s+i[4]*r+i[8]*n)/a,t[1]=(i[1]*s+i[5]*r+i[9]*n)/a,t[2]=(i[2]*s+i[6]*r+i[10]*n)/a}(this,this,t),this}applyQuaternion(t){return function(t,e,i){let s=e[0],r=e[1],n=e[2],a=i[0],h=i[1],o=i[2],l=h*n-o*r,u=o*s-a*n,c=a*r-h*s,d=h*c-o*u,m=o*l-a*c,p=a*u-h*l,g=2*i[3];l*=g,u*=g,c*=g,d*=2,m*=2,p*=2,t[0]=s+l+d,t[1]=r+u+m,t[2]=n+c+p}(this,this,t),this}angle(t){return l(this,t)}lerp(t,e){return function(t,e,i,s){let r=e[0],n=e[1],a=e[2];t[0]=r+s*(i[0]-r),t[1]=n+s*(i[1]-n),t[2]=a+s*(i[2]-a)}(this,this,t,e),this}clone(){return new u(this[0],this[1],this[2])}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t}transformDirection(t){const e=this[0],i=this[1],s=this[2];return this[0]=t[0]*e+t[4]*i+t[8]*s,this[1]=t[1]*e+t[5]*i+t[9]*s,this[2]=t[2]*e+t[6]*i+t[10]*s,this.normalize()}}function c(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function d(t,e,i,s,r){return t[0]=e,t[1]=i,t[2]=s,t[3]=r,t}function m(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t}function p(t,e){let i=e[0],s=e[1],r=e[2],n=e[3],a=i*i+s*s+r*r+n*n;return a>0&&(a=1/Math.sqrt(a)),t[0]=i*a,t[1]=s*a,t[2]=r*a,t[3]=n*a,t}function g(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function f(t,e,i){let s=e[0],r=e[1],n=e[2],a=e[3],h=i[0],o=i[1],l=i[2],u=i[3];return t[0]=s*u+a*h+r*l-n*o,t[1]=r*u+a*o+n*h-s*l,t[2]=n*u+a*l+s*o-r*h,t[3]=a*u-s*h-r*o-n*l,t}const x=c,y=d,b=g,w=p;class v extends Array{constructor(t=0,e=0,i=0,s=1){return super(t,e,i,s),this.onChange=()=>{},this}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}get w(){return this[3]}set x(t){this[0]=t,this.onChange()}set y(t){this[1]=t,this.onChange()}set z(t){this[2]=t,this.onChange()}set w(t){this[3]=t,this.onChange()}identity(){var t;return(t=this)[0]=0,t[1]=0,t[2]=0,t[3]=1,this.onChange(),this}set(t,e,i,s){return t.length?this.copy(t):(y(this,t,e,i,s),this.onChange(),this)}rotateX(t){return function(t,e,i){i*=.5;let s=e[0],r=e[1],n=e[2],a=e[3],h=Math.sin(i),o=Math.cos(i);t[0]=s*o+a*h,t[1]=r*o+n*h,t[2]=n*o-r*h,t[3]=a*o-s*h}(this,this,t),this.onChange(),this}rotateY(t){return function(t,e,i){i*=.5;let s=e[0],r=e[1],n=e[2],a=e[3],h=Math.sin(i),o=Math.cos(i);t[0]=s*o-n*h,t[1]=r*o+a*h,t[2]=n*o+s*h,t[3]=a*o-r*h}(this,this,t),this.onChange(),this}rotateZ(t){return function(t,e,i){i*=.5;let s=e[0],r=e[1],n=e[2],a=e[3],h=Math.sin(i),o=Math.cos(i);t[0]=s*o+r*h,t[1]=r*o-s*h,t[2]=n*o+a*h,t[3]=a*o-n*h}(this,this,t),this.onChange(),this}inverse(t=this){return function(t,e){let i=e[0],s=e[1],r=e[2],n=e[3],a=i*i+s*s+r*r+n*n,h=a?1/a:0;t[0]=-i*h,t[1]=-s*h,t[2]=-r*h,t[3]=n*h}(this,t),this.onChange(),this}conjugate(t=this){var e,i;return i=t,(e=this)[0]=-i[0],e[1]=-i[1],e[2]=-i[2],e[3]=i[3],this.onChange(),this}copy(t){return x(this,t),this.onChange(),this}normalize(t=this){return w(this,t),this.onChange(),this}multiply(t,e){return e?f(this,t,e):f(this,this,t),this.onChange(),this}dot(t){return b(this,t)}fromMatrix3(t){return function(t,e){let i,s=e[0]+e[4]+e[8];if(s>0)i=Math.sqrt(s+1),t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{let s=0;e[4]>e[0]&&(s=1),e[8]>e[3*s+s]&&(s=2);let r=(s+1)%3,n=(s+2)%3;i=Math.sqrt(e[3*s+s]-e[3*r+r]-e[3*n+n]+1),t[s]=.5*i,i=.5/i,t[3]=(e[3*r+n]-e[3*n+r])*i,t[r]=(e[3*r+s]+e[3*s+r])*i,t[n]=(e[3*n+s]+e[3*s+n])*i}}(this,t),this.onChange(),this}fromEuler(t){return function(t,e,i="YXZ"){let s=Math.sin(.5*e[0]),r=Math.cos(.5*e[0]),n=Math.sin(.5*e[1]),a=Math.cos(.5*e[1]),h=Math.sin(.5*e[2]),o=Math.cos(.5*e[2]);"XYZ"===i?(t[0]=s*a*o+r*n*h,t[1]=r*n*o-s*a*h,t[2]=r*a*h+s*n*o,t[3]=r*a*o-s*n*h):"YXZ"===i?(t[0]=s*a*o+r*n*h,t[1]=r*n*o-s*a*h,t[2]=r*a*h-s*n*o,t[3]=r*a*o+s*n*h):"ZXY"===i?(t[0]=s*a*o-r*n*h,t[1]=r*n*o+s*a*h,t[2]=r*a*h+s*n*o,t[3]=r*a*o-s*n*h):"ZYX"===i?(t[0]=s*a*o-r*n*h,t[1]=r*n*o+s*a*h,t[2]=r*a*h-s*n*o,t[3]=r*a*o+s*n*h):"YZX"===i?(t[0]=s*a*o+r*n*h,t[1]=r*n*o+s*a*h,t[2]=r*a*h-s*n*o,t[3]=r*a*o-s*n*h):"XZY"===i&&(t[0]=s*a*o-r*n*h,t[1]=r*n*o-s*a*h,t[2]=r*a*h+s*n*o,t[3]=r*a*o+s*n*h)}(this,t,t.order),this}fromAxisAngle(t,e){return function(t,e,i){i*=.5;let s=Math.sin(i);t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=Math.cos(i)}(this,t,e),this.onChange(),this}slerp(t,e){return function(t,e,i,s){let r,n,a,h,o,l=e[0],u=e[1],c=e[2],d=e[3],m=i[0],p=i[1],g=i[2],f=i[3];n=l*m+u*p+c*g+d*f,n<0&&(n=-n,m=-m,p=-p,g=-g,f=-f),1-n>1e-6?(r=Math.acos(n),a=Math.sin(r),h=Math.sin((1-s)*r)/a,o=Math.sin(s*r)/a):(h=1-s,o=s),t[0]=h*l+o*m,t[1]=h*u+o*p,t[2]=h*c+o*g,t[3]=h*d+o*f}(this,this,t,e),this.onChange(),this}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this[3]=t[e+3],this.onChange(),this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t[e+3]=this[3],t}}function M(t,e,i){let s=e[0],r=e[1],n=e[2],a=e[3],h=e[4],o=e[5],l=e[6],u=e[7],c=e[8],d=e[9],m=e[10],p=e[11],g=e[12],f=e[13],x=e[14],y=e[15],b=i[0],w=i[1],v=i[2],M=i[3];return t[0]=b*s+w*h+v*c+M*g,t[1]=b*r+w*o+v*d+M*f,t[2]=b*n+w*l+v*m+M*x,t[3]=b*a+w*u+v*p+M*y,b=i[4],w=i[5],v=i[6],M=i[7],t[4]=b*s+w*h+v*c+M*g,t[5]=b*r+w*o+v*d+M*f,t[6]=b*n+w*l+v*m+M*x,t[7]=b*a+w*u+v*p+M*y,b=i[8],w=i[9],v=i[10],M=i[11],t[8]=b*s+w*h+v*c+M*g,t[9]=b*r+w*o+v*d+M*f,t[10]=b*n+w*l+v*m+M*x,t[11]=b*a+w*u+v*p+M*y,b=i[12],w=i[13],v=i[14],M=i[15],t[12]=b*s+w*h+v*c+M*g,t[13]=b*r+w*o+v*d+M*f,t[14]=b*n+w*l+v*m+M*x,t[15]=b*a+w*u+v*p+M*y,t}function A(t,e){let i=e[0],s=e[1],r=e[2],n=e[4],a=e[5],h=e[6],o=e[8],l=e[9],u=e[10];return t[0]=Math.hypot(i,s,r),t[1]=Math.hypot(n,a,h),t[2]=Math.hypot(o,l,u),t}const E=function(){const t=[0,0,0];return function(e,i){let s=t;A(s,i);let r=1/s[0],n=1/s[1],a=1/s[2],h=i[0]*r,o=i[1]*n,l=i[2]*a,u=i[4]*r,c=i[5]*n,d=i[6]*a,m=i[8]*r,p=i[9]*n,g=i[10]*a,f=h+c+g,x=0;return f>0?(x=2*Math.sqrt(f+1),e[3]=.25*x,e[0]=(d-p)/x,e[1]=(m-l)/x,e[2]=(o-u)/x):h>c&&h>g?(x=2*Math.sqrt(1+h-c-g),e[3]=(d-p)/x,e[0]=.25*x,e[1]=(o+u)/x,e[2]=(m+l)/x):c>g?(x=2*Math.sqrt(1+c-h-g),e[3]=(m-l)/x,e[0]=(o+u)/x,e[1]=.25*x,e[2]=(d+p)/x):(x=2*Math.sqrt(1+g-h-c),e[3]=(o-u)/x,e[0]=(m+l)/x,e[1]=(d+p)/x,e[2]=.25*x),e}}();function T(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t[8]=e[8]+i[8],t[9]=e[9]+i[9],t[10]=e[10]+i[10],t[11]=e[11]+i[11],t[12]=e[12]+i[12],t[13]=e[13]+i[13],t[14]=e[14]+i[14],t[15]=e[15]+i[15],t}function _(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t[6]=e[6]-i[6],t[7]=e[7]-i[7],t[8]=e[8]-i[8],t[9]=e[9]-i[9],t[10]=e[10]-i[10],t[11]=e[11]-i[11],t[12]=e[12]-i[12],t[13]=e[13]-i[13],t[14]=e[14]-i[14],t[15]=e[15]-i[15],t}class F extends Array{constructor(t=1,e=0,i=0,s=0,r=0,n=1,a=0,h=0,o=0,l=0,u=1,c=0,d=0,m=0,p=0,g=1){return super(t,e,i,s,r,n,a,h,o,l,u,c,d,m,p,g),this}get x(){return this[12]}get y(){return this[13]}get z(){return this[14]}get w(){return this[15]}set x(t){this[12]=t}set y(t){this[13]=t}set z(t){this[14]=t}set w(t){this[15]=t}set(t,e,i,s,r,n,a,h,o,l,u,c,d,m,p,g){return t.length?this.copy(t):(function(t,e,i,s,r,n,a,h,o,l,u,c,d,m,p,g,f){t[0]=e,t[1]=i,t[2]=s,t[3]=r,t[4]=n,t[5]=a,t[6]=h,t[7]=o,t[8]=l,t[9]=u,t[10]=c,t[11]=d,t[12]=m,t[13]=p,t[14]=g,t[15]=f}(this,t,e,i,s,r,n,a,h,o,l,u,c,d,m,p,g),this)}translate(t,e=this){return function(t,e,i){let s,r,n,a,h,o,l,u,c,d,m,p,g=i[0],f=i[1],x=i[2];e===t?(t[12]=e[0]*g+e[4]*f+e[8]*x+e[12],t[13]=e[1]*g+e[5]*f+e[9]*x+e[13],t[14]=e[2]*g+e[6]*f+e[10]*x+e[14],t[15]=e[3]*g+e[7]*f+e[11]*x+e[15]):(s=e[0],r=e[1],n=e[2],a=e[3],h=e[4],o=e[5],l=e[6],u=e[7],c=e[8],d=e[9],m=e[10],p=e[11],t[0]=s,t[1]=r,t[2]=n,t[3]=a,t[4]=h,t[5]=o,t[6]=l,t[7]=u,t[8]=c,t[9]=d,t[10]=m,t[11]=p,t[12]=s*g+h*f+c*x+e[12],t[13]=r*g+o*f+d*x+e[13],t[14]=n*g+l*f+m*x+e[14],t[15]=a*g+u*f+p*x+e[15])}(this,e,t),this}rotate(t,e,i=this){return function(t,e,i,s){let r,n,a,h,o,l,u,c,d,m,p,g,f,x,y,b,w,v,M,A,E,T,_,F,S=s[0],C=s[1],R=s[2],O=Math.hypot(S,C,R);Math.abs(O)<1e-6||(O=1/O,S*=O,C*=O,R*=O,r=Math.sin(i),n=Math.cos(i),a=1-n,h=e[0],o=e[1],l=e[2],u=e[3],c=e[4],d=e[5],m=e[6],p=e[7],g=e[8],f=e[9],x=e[10],y=e[11],b=S*S*a+n,w=C*S*a+R*r,v=R*S*a-C*r,M=S*C*a-R*r,A=C*C*a+n,E=R*C*a+S*r,T=S*R*a+C*r,_=C*R*a-S*r,F=R*R*a+n,t[0]=h*b+c*w+g*v,t[1]=o*b+d*w+f*v,t[2]=l*b+m*w+x*v,t[3]=u*b+p*w+y*v,t[4]=h*M+c*A+g*E,t[5]=o*M+d*A+f*E,t[6]=l*M+m*A+x*E,t[7]=u*M+p*A+y*E,t[8]=h*T+c*_+g*F,t[9]=o*T+d*_+f*F,t[10]=l*T+m*_+x*F,t[11]=u*T+p*_+y*F,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]))}(this,i,t,e),this}scale(t,e=this){return function(t,e,i){let s=i[0],r=i[1],n=i[2];t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]}(this,e,"number"==typeof t?[t,t,t]:t),this}add(t,e){return e?T(this,t,e):T(this,this,t),this}sub(t,e){return e?_(this,t,e):_(this,this,t),this}multiply(t,e){var i,s,r;return t.length?e?M(this,t,e):M(this,this,t):(s=this,r=t,(i=this)[0]=s[0]*r,i[1]=s[1]*r,i[2]=s[2]*r,i[3]=s[3]*r,i[4]=s[4]*r,i[5]=s[5]*r,i[6]=s[6]*r,i[7]=s[7]*r,i[8]=s[8]*r,i[9]=s[9]*r,i[10]=s[10]*r,i[11]=s[11]*r,i[12]=s[12]*r,i[13]=s[13]*r,i[14]=s[14]*r,i[15]=s[15]*r),this}identity(){var t;return(t=this)[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}copy(t){var e,i;return i=t,(e=this)[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}fromPerspective({fov:t,aspect:e,near:i,far:s}={}){return function(t,e,i,s,r){let n=1/Math.tan(e/2),a=1/(s-r);t[0]=n/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(r+s)*a,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*r*s*a,t[15]=0}(this,t,e,i,s),this}fromOrthogonal({left:t,right:e,bottom:i,top:s,near:r,far:n}){return function(t,e,i,s,r,n,a){let h=1/(e-i),o=1/(s-r),l=1/(n-a);t[0]=-2*h,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+i)*h,t[13]=(r+s)*o,t[14]=(a+n)*l,t[15]=1}(this,t,e,i,s,r,n),this}fromQuaternion(t){return function(t,e){let i=e[0],s=e[1],r=e[2],n=e[3],a=i+i,h=s+s,o=r+r,l=i*a,u=s*a,c=s*h,d=r*a,m=r*h,p=r*o,g=n*a,f=n*h,x=n*o;t[0]=1-c-p,t[1]=u+x,t[2]=d-f,t[3]=0,t[4]=u-x,t[5]=1-l-p,t[6]=m+g,t[7]=0,t[8]=d+f,t[9]=m-g,t[10]=1-l-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(this,t),this}setPosition(t){return this.x=t[0],this.y=t[1],this.z=t[2],this}inverse(t=this){return function(t,e){let i=e[0],s=e[1],r=e[2],n=e[3],a=e[4],h=e[5],o=e[6],l=e[7],u=e[8],c=e[9],d=e[10],m=e[11],p=e[12],g=e[13],f=e[14],x=e[15],y=i*h-s*a,b=i*o-r*a,w=i*l-n*a,v=s*o-r*h,M=s*l-n*h,A=r*l-n*o,E=u*g-c*p,T=u*f-d*p,_=u*x-m*p,F=c*f-d*g,S=c*x-m*g,C=d*x-m*f,R=y*C-b*S+w*F+v*_-M*T+A*E;R&&(R=1/R,t[0]=(h*C-o*S+l*F)*R,t[1]=(r*S-s*C-n*F)*R,t[2]=(g*A-f*M+x*v)*R,t[3]=(d*M-c*A-m*v)*R,t[4]=(o*_-a*C-l*T)*R,t[5]=(i*C-r*_+n*T)*R,t[6]=(f*w-p*A-x*b)*R,t[7]=(u*A-d*w+m*b)*R,t[8]=(a*S-h*_+l*E)*R,t[9]=(s*_-i*S-n*E)*R,t[10]=(p*M-g*w+x*y)*R,t[11]=(c*w-u*M-m*y)*R,t[12]=(h*T-a*F-o*E)*R,t[13]=(i*F-s*T+r*E)*R,t[14]=(g*b-p*v-f*y)*R,t[15]=(u*v-c*b+d*y)*R)}(this,t),this}compose(t,e,i){return function(t,e,i,s){let r=e[0],n=e[1],a=e[2],h=e[3],o=r+r,l=n+n,u=a+a,c=r*o,d=r*l,m=r*u,p=n*l,g=n*u,f=a*u,x=h*o,y=h*l,b=h*u,w=s[0],v=s[1],M=s[2];t[0]=(1-(p+f))*w,t[1]=(d+b)*w,t[2]=(m-y)*w,t[3]=0,t[4]=(d-b)*v,t[5]=(1-(c+f))*v,t[6]=(g+x)*v,t[7]=0,t[8]=(m+y)*M,t[9]=(g-x)*M,t[10]=(1-(c+p))*M,t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1}(this,t,e,i),this}getRotation(t){return E(t,this),this}getTranslation(t){var e,i;return i=this,(e=t)[0]=i[12],e[1]=i[13],e[2]=i[14],this}getScaling(t){return A(t,this),this}getMaxScaleOnAxis(){return function(t){let e=t[0],i=t[1],s=t[2],r=t[4],n=t[5],a=t[6],h=t[8],o=t[9],l=t[10];const u=e*e+i*i+s*s,c=r*r+n*n+a*a,d=h*h+o*o+l*l;return Math.sqrt(Math.max(u,c,d))}(this)}lookAt(t,e,i){return function(t,e,i,s){let r=e[0],n=e[1],a=e[2],h=s[0],o=s[1],l=s[2],u=r-i[0],c=n-i[1],d=a-i[2],m=u*u+c*c+d*d;0===m?d=1:(m=1/Math.sqrt(m),u*=m,c*=m,d*=m);let p=o*d-l*c,g=l*u-h*d,f=h*c-o*u;m=p*p+g*g+f*f,0===m&&(l?h+=1e-6:o?l+=1e-6:o+=1e-6,p=o*d-l*c,g=l*u-h*d,f=h*c-o*u,m=p*p+g*g+f*f),m=1/Math.sqrt(m),p*=m,g*=m,f*=m,t[0]=p,t[1]=g,t[2]=f,t[3]=0,t[4]=c*f-d*g,t[5]=d*p-u*f,t[6]=u*g-c*p,t[7]=0,t[8]=u,t[9]=c,t[10]=d,t[11]=0,t[12]=r,t[13]=n,t[14]=a,t[15]=1}(this,t,e,i),this}determinant(){return function(t){let e=t[0],i=t[1],s=t[2],r=t[3],n=t[4],a=t[5],h=t[6],o=t[7],l=t[8],u=t[9],c=t[10],d=t[11],m=t[12],p=t[13],g=t[14],f=t[15];return(e*a-i*n)*(c*f-d*g)-(e*h-s*n)*(u*f-d*p)+(e*o-r*n)*(u*g-c*p)+(i*h-s*a)*(l*f-d*m)-(i*o-r*a)*(l*g-c*m)+(s*o-r*h)*(l*p-u*m)}(this)}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this[3]=t[e+3],this[4]=t[e+4],this[5]=t[e+5],this[6]=t[e+6],this[7]=t[e+7],this[8]=t[e+8],this[9]=t[e+9],this[10]=t[e+10],this[11]=t[e+11],this[12]=t[e+12],this[13]=t[e+13],this[14]=t[e+14],this[15]=t[e+15],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t[e+3]=this[3],t[e+4]=this[4],t[e+5]=this[5],t[e+6]=this[6],t[e+7]=this[7],t[e+8]=this[8],t[e+9]=this[9],t[e+10]=this[10],t[e+11]=this[11],t[e+12]=this[12],t[e+13]=this[13],t[e+14]=this[14],t[e+15]=this[15],t}}const S=new F;class C extends Array{constructor(t=0,e=t,i=t,s="YXZ"){return super(t,e,i),this.order=s,this.onChange=()=>{},this}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}set x(t){this[0]=t,this.onChange()}set y(t){this[1]=t,this.onChange()}set z(t){this[2]=t,this.onChange()}set(t,e=t,i=t){return t.length?this.copy(t):(this[0]=t,this[1]=e,this[2]=i,this.onChange(),this)}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this.onChange(),this}reorder(t){return this.order=t,this.onChange(),this}fromRotationMatrix(t,e=this.order){return function(t,e,i="YXZ"){"XYZ"===i?(t[1]=Math.asin(Math.min(Math.max(e[8],-1),1)),Math.abs(e[8])<.99999?(t[0]=Math.atan2(-e[9],e[10]),t[2]=Math.atan2(-e[4],e[0])):(t[0]=Math.atan2(e[6],e[5]),t[2]=0)):"YXZ"===i?(t[0]=Math.asin(-Math.min(Math.max(e[9],-1),1)),Math.abs(e[9])<.99999?(t[1]=Math.atan2(e[8],e[10]),t[2]=Math.atan2(e[1],e[5])):(t[1]=Math.atan2(-e[2],e[0]),t[2]=0)):"ZXY"===i?(t[0]=Math.asin(Math.min(Math.max(e[6],-1),1)),Math.abs(e[6])<.99999?(t[1]=Math.atan2(-e[2],e[10]),t[2]=Math.atan2(-e[4],e[5])):(t[1]=0,t[2]=Math.atan2(e[1],e[0]))):"ZYX"===i?(t[1]=Math.asin(-Math.min(Math.max(e[2],-1),1)),Math.abs(e[2])<.99999?(t[0]=Math.atan2(e[6],e[10]),t[2]=Math.atan2(e[1],e[0])):(t[0]=0,t[2]=Math.atan2(-e[4],e[5]))):"YZX"===i?(t[2]=Math.asin(Math.min(Math.max(e[1],-1),1)),Math.abs(e[1])<.99999?(t[0]=Math.atan2(-e[9],e[5]),t[1]=Math.atan2(-e[2],e[0])):(t[0]=0,t[1]=Math.atan2(e[8],e[10]))):"XZY"===i&&(t[2]=Math.asin(-Math.min(Math.max(e[4],-1),1)),Math.abs(e[4])<.99999?(t[0]=Math.atan2(e[6],e[5]),t[1]=Math.atan2(e[8],e[0])):(t[0]=Math.atan2(-e[9],e[10]),t[1]=0))}(this,t,e),this.onChange(),this}fromQuaternion(t,e=this.order){return S.fromQuaternion(t),this.fromRotationMatrix(S,e)}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t}}class R{constructor(){this.parent=null,this.children=[],this.visible=!0,this.matrix=new F,this.worldMatrix=new F,this.matrixAutoUpdate=!0,this.position=new u,this.quaternion=new v,this.scale=new u(1),this.rotation=new C,this.up=new u(0,1,0),this.rotation.onChange=()=>this.quaternion.fromEuler(this.rotation),this.quaternion.onChange=()=>this.rotation.fromQuaternion(this.quaternion)}setParent(t,e=!0){this.parent&&t!==this.parent&&this.parent.removeChild(this,!1),this.parent=t,e&&t&&t.addChild(this,!1)}addChild(t,e=!0){~this.children.indexOf(t)||this.children.push(t),e&&t.setParent(this,!1)}removeChild(t,e=!0){~this.children.indexOf(t)&&this.children.splice(this.children.indexOf(t),1),e&&t.setParent(null,!1)}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.worldMatrixNeedsUpdate||t)&&(null===this.parent?this.worldMatrix.copy(this.matrix):this.worldMatrix.multiply(this.parent.worldMatrix,this.matrix),this.worldMatrixNeedsUpdate=!1,t=!0);for(let e=0,i=this.children.length;e<i;e++)this.children[e].updateMatrixWorld(t)}updateMatrix(){this.matrix.compose(this.quaternion,this.position,this.scale),this.worldMatrixNeedsUpdate=!0}traverse(t){if(!t(this))for(let e=0,i=this.children.length;e<i;e++)this.children[e].traverse(t)}decompose(){this.matrix.getTranslation(this.position),this.matrix.getRotation(this.quaternion),this.matrix.getScaling(this.scale),this.rotation.fromQuaternion(this.quaternion)}lookAt(t,e=!1){e?this.matrix.lookAt(this.position,t,this.up):this.matrix.lookAt(t,this.position,this.up),this.matrix.getRotation(this.quaternion),this.rotation.fromQuaternion(this.quaternion)}}const O=new F,L=new u,P=new u;class N extends R{constructor(t,{near:e=.1,far:i=100,fov:s=45,aspect:r=1,left:n,right:a,bottom:h,top:o,zoom:l=1}={}){super(),Object.assign(this,{near:e,far:i,fov:s,aspect:r,left:n,right:a,bottom:h,top:o,zoom:l}),this.projectionMatrix=new F,this.viewMatrix=new F,this.projectionViewMatrix=new F,this.worldPosition=new u,this.type=n||a?"orthographic":"perspective","orthographic"===this.type?this.orthographic():this.perspective()}perspective({near:t=this.near,far:e=this.far,fov:i=this.fov,aspect:s=this.aspect}={}){return Object.assign(this,{near:t,far:e,fov:i,aspect:s}),this.projectionMatrix.fromPerspective({fov:i*(Math.PI/180),aspect:s,near:t,far:e}),this.type="perspective",this}orthographic({near:t=this.near,far:e=this.far,left:i=this.left,right:s=this.right,bottom:r=this.bottom,top:n=this.top,zoom:a=this.zoom}={}){return Object.assign(this,{near:t,far:e,left:i,right:s,bottom:r,top:n,zoom:a}),i/=a,s/=a,r/=a,n/=a,this.projectionMatrix.fromOrthogonal({left:i,right:s,bottom:r,top:n,near:t,far:e}),this.type="orthographic",this}updateMatrixWorld(){return super.updateMatrixWorld(),this.viewMatrix.inverse(this.worldMatrix),this.worldMatrix.getTranslation(this.worldPosition),this.projectionViewMatrix.multiply(this.projectionMatrix,this.viewMatrix),this}lookAt(t){return super.lookAt(t,!0),this}project(t){return t.applyMatrix4(this.viewMatrix),t.applyMatrix4(this.projectionMatrix),this}unproject(t){return t.applyMatrix4(O.inverse(this.projectionMatrix)),t.applyMatrix4(this.worldMatrix),this}updateFrustum(){this.frustum||(this.frustum=[new u,new u,new u,new u,new u,new u]);const t=this.projectionViewMatrix;this.frustum[0].set(t[3]-t[0],t[7]-t[4],t[11]-t[8]).constant=t[15]-t[12],this.frustum[1].set(t[3]+t[0],t[7]+t[4],t[11]+t[8]).constant=t[15]+t[12],this.frustum[2].set(t[3]+t[1],t[7]+t[5],t[11]+t[9]).constant=t[15]+t[13],this.frustum[3].set(t[3]-t[1],t[7]-t[5],t[11]-t[9]).constant=t[15]-t[13],this.frustum[4].set(t[3]-t[2],t[7]-t[6],t[11]-t[10]).constant=t[15]-t[14],this.frustum[5].set(t[3]+t[2],t[7]+t[6],t[11]+t[10]).constant=t[15]+t[14];for(let t=0;t<6;t++){const e=1/this.frustum[t].distance();this.frustum[t].multiply(e),this.frustum[t].constant*=e}}frustumIntersectsMesh(t,e=t.worldMatrix){if(!t.geometry.attributes.position)return!0;if(t.geometry.bounds&&t.geometry.bounds.radius!==1/0||t.geometry.computeBoundingSphere(),!t.geometry.bounds)return!0;const i=L;i.copy(t.geometry.bounds.center),i.applyMatrix4(e);const s=t.geometry.bounds.radius*e.getMaxScaleOnAxis();return this.frustumIntersectsSphere(i,s)}frustumIntersectsSphere(t,e){const i=P;for(let s=0;s<6;s++){const r=this.frustum[s];if(i.copy(r).dot(t)+r.constant<-e)return!1}return!0}}const B=new u;let I=1,U=1,z=!1;class D{constructor(t,e={}){t.canvas||console.error("gl not passed as first argument to Geometry"),this.gl=t,this.attributes=e,this.id=I++,this.VAOs={},this.drawRange={start:0,count:0},this.instancedCount=0,this.gl.renderer.bindVertexArray(null),this.gl.renderer.currentGeometry=null,this.glState=this.gl.renderer.state;for(let t in e)this.addAttribute(t,e[t])}addAttribute(t,e){if(this.attributes[t]=e,e.id=U++,e.size=e.size||1,e.type=e.type||(e.data.constructor===Float32Array?this.gl.FLOAT:e.data.constructor===Uint16Array?this.gl.UNSIGNED_SHORT:this.gl.UNSIGNED_INT),e.target="index"===t?this.gl.ELEMENT_ARRAY_BUFFER:this.gl.ARRAY_BUFFER,e.normalized=e.normalized||!1,e.stride=e.stride||0,e.offset=e.offset||0,e.count=e.count||(e.stride?e.data.byteLength/e.stride:e.data.length/e.size),e.divisor=e.instanced||0,e.needsUpdate=!1,e.usage=e.usage||this.gl.STATIC_DRAW,e.buffer||this.updateAttribute(e),e.divisor){if(this.isInstanced=!0,this.instancedCount&&this.instancedCount!==e.count*e.divisor)return console.warn("geometry has multiple instanced buffers of different length"),this.instancedCount=Math.min(this.instancedCount,e.count*e.divisor);this.instancedCount=e.count*e.divisor}else"index"===t?this.drawRange.count=e.count:this.attributes.index||(this.drawRange.count=Math.max(this.drawRange.count,e.count))}updateAttribute(t){const e=!t.buffer;e&&(t.buffer=this.gl.createBuffer()),this.glState.boundBuffer!==t.buffer&&(this.gl.bindBuffer(t.target,t.buffer),this.glState.boundBuffer=t.buffer),e?this.gl.bufferData(t.target,t.data,t.usage):this.gl.bufferSubData(t.target,0,t.data),t.needsUpdate=!1}setIndex(t){this.addAttribute("index",t)}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}setInstancedCount(t){this.instancedCount=t}createVAO(t){this.VAOs[t.attributeOrder]=this.gl.renderer.createVertexArray(),this.gl.renderer.bindVertexArray(this.VAOs[t.attributeOrder]),this.bindAttributes(t)}bindAttributes(t){t.attributeLocations.forEach(((t,{name:e,type:i})=>{if(!this.attributes[e])return void console.warn(`active attribute ${e} not being supplied`);const s=this.attributes[e];this.gl.bindBuffer(s.target,s.buffer),this.glState.boundBuffer=s.buffer;let r=1;35674===i&&(r=2),35675===i&&(r=3),35676===i&&(r=4);const n=s.size/r,a=1===r?0:r*r*4,h=1===r?0:4*r;for(let e=0;e<r;e++)this.gl.vertexAttribPointer(t+e,n,s.type,s.normalized,s.stride+a,s.offset+e*h),this.gl.enableVertexAttribArray(t+e),this.gl.renderer.vertexAttribDivisor(t+e,s.divisor)})),this.attributes.index&&this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.attributes.index.buffer)}draw({program:t,mode:e=this.gl.TRIANGLES}){this.gl.renderer.currentGeometry!==`${this.id}_${t.attributeOrder}`&&(this.VAOs[t.attributeOrder]||this.createVAO(t),this.gl.renderer.bindVertexArray(this.VAOs[t.attributeOrder]),this.gl.renderer.currentGeometry=`${this.id}_${t.attributeOrder}`),t.attributeLocations.forEach(((t,{name:e})=>{const i=this.attributes[e];i.needsUpdate&&this.updateAttribute(i)}));let i=2;this.attributes.index?.type===this.gl.UNSIGNED_INT&&(i=4),this.isInstanced?this.attributes.index?this.gl.renderer.drawElementsInstanced(e,this.drawRange.count,this.attributes.index.type,this.attributes.index.offset+this.drawRange.start*i,this.instancedCount):this.gl.renderer.drawArraysInstanced(e,this.drawRange.start,this.drawRange.count,this.instancedCount):this.attributes.index?this.gl.drawElements(e,this.drawRange.count,this.attributes.index.type,this.attributes.index.offset+this.drawRange.start*i):this.gl.drawArrays(e,this.drawRange.start,this.drawRange.count)}getPosition(){const t=this.attributes.position;return t.data?t:z?void 0:(console.warn("No position buffer data found to compute bounds"),z=!0)}computeBoundingBox(t){t||(t=this.getPosition());const e=t.data,i=t.size;this.bounds||(this.bounds={min:new u,max:new u,center:new u,scale:new u,radius:1/0});const s=this.bounds.min,r=this.bounds.max,n=this.bounds.center,a=this.bounds.scale;s.set(1/0),r.set(-1/0);for(let t=0,n=e.length;t<n;t+=i){const i=e[t],n=e[t+1],a=e[t+2];s.x=Math.min(i,s.x),s.y=Math.min(n,s.y),s.z=Math.min(a,s.z),r.x=Math.max(i,r.x),r.y=Math.max(n,r.y),r.z=Math.max(a,r.z)}a.sub(r,s),n.add(s,r).divide(2)}computeBoundingSphere(t){t||(t=this.getPosition());const e=t.data,i=t.size;this.bounds||this.computeBoundingBox(t);let s=0;for(let t=0,r=e.length;t<r;t+=i)B.fromArray(e,t),s=Math.max(s,this.bounds.center.squaredDistance(B));this.bounds.radius=Math.sqrt(s)}remove(){for(let t in this.VAOs)this.gl.renderer.deleteVertexArray(this.VAOs[t]),delete this.VAOs[t];for(let t in this.attributes)this.gl.deleteBuffer(this.attributes[t].buffer),delete this.attributes[t]}}const k=new Uint8Array(4);function V(t){return 0==(t&t-1)}let j=1;class q{constructor(t,{image:e,target:i=t.TEXTURE_2D,type:s=t.UNSIGNED_BYTE,format:r=t.RGBA,internalFormat:n=r,wrapS:a=t.CLAMP_TO_EDGE,wrapT:h=t.CLAMP_TO_EDGE,generateMipmaps:o=!0,minFilter:l=(o?t.NEAREST_MIPMAP_LINEAR:t.LINEAR),magFilter:u=t.LINEAR,premultiplyAlpha:c=!1,unpackAlignment:d=4,flipY:m=i==t.TEXTURE_2D,anisotropy:p=0,level:g=0,width:f,height:x=f}={}){this.gl=t,this.id=j++,this.image=e,this.target=i,this.type=s,this.format=r,this.internalFormat=n,this.minFilter=l,this.magFilter=u,this.wrapS=a,this.wrapT=h,this.generateMipmaps=o,this.premultiplyAlpha=c,this.unpackAlignment=d,this.flipY=m,this.anisotropy=Math.min(p,this.gl.renderer.parameters.maxAnisotropy),this.level=g,this.width=f,this.height=x,this.texture=this.gl.createTexture(),this.store={image:null},this.glState=this.gl.renderer.state,this.state={},this.state.minFilter=this.gl.NEAREST_MIPMAP_LINEAR,this.state.magFilter=this.gl.LINEAR,this.state.wrapS=this.gl.REPEAT,this.state.wrapT=this.gl.REPEAT,this.state.anisotropy=0}bind(){this.glState.textureUnits[this.glState.activeTextureUnit]!==this.id&&(this.gl.bindTexture(this.target,this.texture),this.glState.textureUnits[this.glState.activeTextureUnit]=this.id)}update(t=0){const e=!(this.image===this.store.image&&!this.needsUpdate);if((e||this.glState.textureUnits[t]!==this.id)&&(this.gl.renderer.activeTexture(t),this.bind()),e){if(this.needsUpdate=!1,this.flipY!==this.glState.flipY&&(this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,this.flipY),this.glState.flipY=this.flipY),this.premultiplyAlpha!==this.glState.premultiplyAlpha&&(this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),this.glState.premultiplyAlpha=this.premultiplyAlpha),this.unpackAlignment!==this.glState.unpackAlignment&&(this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,this.unpackAlignment),this.glState.unpackAlignment=this.unpackAlignment),this.minFilter!==this.state.minFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MIN_FILTER,this.minFilter),this.state.minFilter=this.minFilter),this.magFilter!==this.state.magFilter&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_MAG_FILTER,this.magFilter),this.state.magFilter=this.magFilter),this.wrapS!==this.state.wrapS&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_S,this.wrapS),this.state.wrapS=this.wrapS),this.wrapT!==this.state.wrapT&&(this.gl.texParameteri(this.target,this.gl.TEXTURE_WRAP_T,this.wrapT),this.state.wrapT=this.wrapT),this.anisotropy&&this.anisotropy!==this.state.anisotropy&&(this.gl.texParameterf(this.target,this.gl.renderer.getExtension("EXT_texture_filter_anisotropic").TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropy),this.state.anisotropy=this.anisotropy),this.image){if(this.image.width&&(this.width=this.image.width,this.height=this.image.height),this.target===this.gl.TEXTURE_CUBE_MAP)for(let t=0;t<6;t++)this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+t,this.level,this.internalFormat,this.format,this.type,this.image[t]);else if(ArrayBuffer.isView(this.image))this.gl.texImage2D(this.target,this.level,this.internalFormat,this.width,this.height,0,this.format,this.type,this.image);else if(this.image.isCompressedTexture)for(let t=0;t<this.image.length;t++)this.gl.compressedTexImage2D(this.target,t,this.internalFormat,this.image[t].width,this.image[t].height,0,this.image[t].data);else this.gl.texImage2D(this.target,this.level,this.internalFormat,this.format,this.type,this.image);this.generateMipmaps&&(this.gl.renderer.isWebgl2||V(this.image.width)&&V(this.image.height)?this.gl.generateMipmap(this.target):(this.generateMipmaps=!1,this.wrapS=this.wrapT=this.gl.CLAMP_TO_EDGE,this.minFilter=this.gl.LINEAR)),this.onUpdate&&this.onUpdate()}else if(this.target===this.gl.TEXTURE_CUBE_MAP)for(let t=0;t<6;t++)this.gl.texImage2D(this.gl.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,k);else this.width?this.gl.texImage2D(this.target,this.level,this.internalFormat,this.width,this.height,0,this.format,this.type,null):this.gl.texImage2D(this.target,0,this.gl.RGBA,1,1,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,k);this.store.image=this.image}}}function X(t,e,i){let s=e[0],r=e[1],n=e[2],a=e[3],h=e[4],o=e[5],l=e[6],u=e[7],c=e[8],d=i[0],m=i[1],p=i[2],g=i[3],f=i[4],x=i[5],y=i[6],b=i[7],w=i[8];return t[0]=d*s+m*a+p*l,t[1]=d*r+m*h+p*u,t[2]=d*n+m*o+p*c,t[3]=g*s+f*a+x*l,t[4]=g*r+f*h+x*u,t[5]=g*n+f*o+x*c,t[6]=y*s+b*a+w*l,t[7]=y*r+b*h+w*u,t[8]=y*n+b*o+w*c,t}class Y extends Array{constructor(t=1,e=0,i=0,s=0,r=1,n=0,a=0,h=0,o=1){return super(t,e,i,s,r,n,a,h,o),this}set(t,e,i,s,r,n,a,h,o){return t.length?this.copy(t):(function(t,e,i,s,r,n,a,h,o,l){t[0]=e,t[1]=i,t[2]=s,t[3]=r,t[4]=n,t[5]=a,t[6]=h,t[7]=o,t[8]=l}(this,t,e,i,s,r,n,a,h,o),this)}translate(t,e=this){return function(t,e,i){let s=e[0],r=e[1],n=e[2],a=e[3],h=e[4],o=e[5],l=e[6],u=e[7],c=e[8],d=i[0],m=i[1];t[0]=s,t[1]=r,t[2]=n,t[3]=a,t[4]=h,t[5]=o,t[6]=d*s+m*a+l,t[7]=d*r+m*h+u,t[8]=d*n+m*o+c}(this,e,t),this}rotate(t,e=this){return function(t,e,i){let s=e[0],r=e[1],n=e[2],a=e[3],h=e[4],o=e[5],l=e[6],u=e[7],c=e[8],d=Math.sin(i),m=Math.cos(i);t[0]=m*s+d*a,t[1]=m*r+d*h,t[2]=m*n+d*o,t[3]=m*a-d*s,t[4]=m*h-d*r,t[5]=m*o-d*n,t[6]=l,t[7]=u,t[8]=c}(this,e,t),this}scale(t,e=this){return function(t,e,i){let s=i[0],r=i[1];t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=r*e[3],t[4]=r*e[4],t[5]=r*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8]}(this,e,t),this}multiply(t,e){return e?X(this,t,e):X(this,this,t),this}identity(){var t;return(t=this)[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this}copy(t){var e,i;return i=t,(e=this)[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],this}fromMatrix4(t){var e,i;return i=t,(e=this)[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[4],e[4]=i[5],e[5]=i[6],e[6]=i[8],e[7]=i[9],e[8]=i[10],this}fromQuaternion(t){return function(t,e){let i=e[0],s=e[1],r=e[2],n=e[3],a=i+i,h=s+s,o=r+r,l=i*a,u=s*a,c=s*h,d=r*a,m=r*h,p=r*o,g=n*a,f=n*h,x=n*o;t[0]=1-c-p,t[3]=u-x,t[6]=d+f,t[1]=u+x,t[4]=1-l-p,t[7]=m-g,t[2]=d-f,t[5]=m+g,t[8]=1-l-c}(this,t),this}fromBasis(t,e,i){return this.set(t[0],t[1],t[2],e[0],e[1],e[2],i[0],i[1],i[2]),this}inverse(t=this){return function(t,e){let i=e[0],s=e[1],r=e[2],n=e[3],a=e[4],h=e[5],o=e[6],l=e[7],u=e[8],c=u*a-h*l,d=-u*n+h*o,m=l*n-a*o,p=i*c+s*d+r*m;p&&(p=1/p,t[0]=c*p,t[1]=(-u*s+r*l)*p,t[2]=(h*s-r*a)*p,t[3]=d*p,t[4]=(u*i-r*o)*p,t[5]=(-h*i+r*n)*p,t[6]=m*p,t[7]=(-l*i+s*o)*p,t[8]=(a*i-s*n)*p)}(this,t),this}getNormalMatrix(t){return function(t,e){let i=e[0],s=e[1],r=e[2],n=e[3],a=e[4],h=e[5],o=e[6],l=e[7],u=e[8],c=e[9],d=e[10],m=e[11],p=e[12],g=e[13],f=e[14],x=e[15],y=i*h-s*a,b=i*o-r*a,w=i*l-n*a,v=s*o-r*h,M=s*l-n*h,A=r*l-n*o,E=u*g-c*p,T=u*f-d*p,_=u*x-m*p,F=c*f-d*g,S=c*x-m*g,C=d*x-m*f,R=y*C-b*S+w*F+v*_-M*T+A*E;R&&(R=1/R,t[0]=(h*C-o*S+l*F)*R,t[1]=(o*_-a*C-l*T)*R,t[2]=(a*S-h*_+l*E)*R,t[3]=(r*S-s*C-n*F)*R,t[4]=(i*C-r*_+n*T)*R,t[5]=(s*_-i*S-n*E)*R,t[6]=(g*A-f*M+x*v)*R,t[7]=(f*w-p*A-x*b)*R,t[8]=(p*M-g*w+x*y)*R)}(this,t),this}}let G=0;class W extends R{constructor(t,{geometry:e,program:i,mode:s=t.TRIANGLES,frustumCulled:r=!0,renderOrder:n=0}={}){super(),t.canvas||console.error("gl not passed as first argument to Mesh"),this.gl=t,this.id=G++,this.geometry=e,this.program=i,this.mode=s,this.frustumCulled=r,this.renderOrder=n,this.modelViewMatrix=new F,this.normalMatrix=new Y,this.beforeRenderCallbacks=[],this.afterRenderCallbacks=[]}onBeforeRender(t){return this.beforeRenderCallbacks.push(t),this}onAfterRender(t){return this.afterRenderCallbacks.push(t),this}draw({camera:t}={}){t&&(this.program.uniforms.modelMatrix||Object.assign(this.program.uniforms,{modelMatrix:{value:null},viewMatrix:{value:null},modelViewMatrix:{value:null},normalMatrix:{value:null},projectionMatrix:{value:null},cameraPosition:{value:null}}),this.program.uniforms.projectionMatrix.value=t.projectionMatrix,this.program.uniforms.cameraPosition.value=t.worldPosition,this.program.uniforms.viewMatrix.value=t.viewMatrix,this.modelViewMatrix.multiply(t.viewMatrix,this.worldMatrix),this.normalMatrix.getNormalMatrix(this.modelViewMatrix),this.program.uniforms.modelMatrix.value=this.worldMatrix,this.program.uniforms.modelViewMatrix.value=this.modelViewMatrix,this.program.uniforms.normalMatrix.value=this.normalMatrix),this.beforeRenderCallbacks.forEach((e=>e&&e({mesh:this,camera:t})));let e=this.program.cullFace&&this.worldMatrix.determinant()<0;this.program.use({flipFaces:e}),this.geometry.draw({mode:this.mode,program:this.program}),this.afterRenderCallbacks.forEach((e=>e&&e({mesh:this,camera:t})))}}const H=new u,Z=new u,$=new u,K=new u,Q=new v,J=new v,tt=new v,et=new v;class it{constructor(t,e=1){this.data=t,this.elapsed=0,this.weight=e,this.loop=!0,this.startTime=t.reduce(((t,{times:e})=>Math.min(t,e[0])),1/0),this.endTime=t.reduce(((t,{times:e})=>Math.max(t,e[e.length-1])),0),this.duration=this.endTime-this.startTime}update(t=1,e){const i=e?1:this.weight/t,s=this.duration?(this.loop?this.elapsed%this.duration:Math.min(this.elapsed,this.duration-.001))+this.startTime:0;this.data.forEach((({node:t,transform:e,interpolation:r,times:n,values:a})=>{if(!this.duration){let s=H,r=3;return"quaternion"===e&&(s=Q,r=4),s.fromArray(a,0),void(4===r?t[e].slerp(s,i):t[e].lerp(s,i))}const h=Math.max(1,n.findIndex((t=>t>s)))-1,o=h+1;let l=(s-n[h])/(n[o]-n[h]);"STEP"===r&&(l=0);let u=H,c=Z,d=$,m=K,p=3;"quaternion"===e&&(u=Q,c=J,d=tt,m=et,p=4),"CUBICSPLINE"===r?(u.fromArray(a,h*p*3+1*p),c.fromArray(a,h*p*3+2*p),d.fromArray(a,o*p*3+0*p),m.fromArray(a,o*p*3+1*p),u=this.cubicSplineInterpolate(l,u,c,d,m),4===p&&u.normalize()):(u.fromArray(a,h*p),m.fromArray(a,o*p),4===p?u.slerp(m,l):u.lerp(m,l)),4===p?t[e].slerp(u,i):t[e].lerp(u,i)}))}cubicSplineInterpolate(t,e,i,s,r){const n=t*t,a=n*t,h=3*n-2*a,o=a-n,l=1-h,u=o-n+t;for(let n=0;n<e.length;n++)e[n]=l*e[n]+u*(1-t)*i[n]+h*r[n]+o*t*s[n];return e}}const st=new F,rt=new F;class nt extends W{constructor(t,{skeleton:e,geometry:i,program:s,mode:r=t.TRIANGLES}={}){super(t,{geometry:i,program:s,mode:r}),this.skeleton=e,this.program=s,this.createBoneTexture()}createBoneTexture(){if(!this.skeleton.joints.length)return;const t=Math.max(4,Math.pow(2,Math.ceil(Math.log(Math.sqrt(4*this.skeleton.joints.length))/Math.LN2)));this.boneMatrices=new Float32Array(t*t*4),this.boneTextureSize=t,this.boneTexture=new q(this.gl,{image:this.boneMatrices,generateMipmaps:!1,type:this.gl.FLOAT,internalFormat:this.gl.renderer.isWebgl2?this.gl.RGBA32F:this.gl.RGBA,minFilter:this.gl.NEAREST,magFilter:this.gl.NEAREST,flipY:!1,width:t})}updateUniforms(){this.skeleton.joints.forEach(((t,e)=>{st.multiply(t.worldMatrix,t.bindInverse),this.boneMatrices.set(st,16*e)})),this.boneTexture&&(this.boneTexture.needsUpdate=!0)}draw({camera:t}={}){this.program.uniforms.boneTexture||Object.assign(this.program.uniforms,{boneTexture:{value:this.boneTexture},boneTextureSize:{value:this.boneTextureSize}}),this.updateUniforms();const e=this.worldMatrix;this.worldMatrix=rt,super.draw({camera:t}),this.worldMatrix=e}}let at=1;const ht={};class ot{constructor(t,{vertex:e,fragment:i,uniforms:s={},transparent:r=!1,cullFace:n=t.BACK,frontFace:a=t.CCW,depthTest:h=!0,depthWrite:o=!0,depthFunc:l=t.LESS}={}){t.canvas||console.error("gl not passed as first argument to Program"),this.gl=t,this.uniforms=s,this.id=at++,e||console.warn("vertex shader not supplied"),i||console.warn("fragment shader not supplied"),this.transparent=r,this.cullFace=n,this.frontFace=a,this.depthTest=h,this.depthWrite=o,this.depthFunc=l,this.blendFunc={},this.blendEquation={},this.transparent&&!this.blendFunc.src&&(this.gl.renderer.premultipliedAlpha?this.setBlendFunc(this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA):this.setBlendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA));const u=t.createShader(t.VERTEX_SHADER);t.shaderSource(u,e),t.compileShader(u),""!==t.getShaderInfoLog(u)&&console.warn(`${t.getShaderInfoLog(u)}\nVertex Shader\n${ut(e)}`);const c=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(c,i),t.compileShader(c),""!==t.getShaderInfoLog(c)&&console.warn(`${t.getShaderInfoLog(c)}\nFragment Shader\n${ut(i)}`),this.program=t.createProgram(),t.attachShader(this.program,u),t.attachShader(this.program,c),t.linkProgram(this.program),!t.getProgramParameter(this.program,t.LINK_STATUS))return console.warn(t.getProgramInfoLog(this.program));t.deleteShader(u),t.deleteShader(c),this.uniformLocations=new Map;let d=t.getProgramParameter(this.program,t.ACTIVE_UNIFORMS);for(let e=0;e<d;e++){let i=t.getActiveUniform(this.program,e);this.uniformLocations.set(i,t.getUniformLocation(this.program,i.name));const s=i.name.match(/(\w+)/g);i.uniformName=s[0],3===s.length?(i.isStructArray=!0,i.structIndex=Number(s[1]),i.structProperty=s[2]):2===s.length&&isNaN(Number(s[1]))&&(i.isStruct=!0,i.structProperty=s[1])}this.attributeLocations=new Map;const m=[],p=t.getProgramParameter(this.program,t.ACTIVE_ATTRIBUTES);for(let e=0;e<p;e++){const i=t.getActiveAttrib(this.program,e),s=t.getAttribLocation(this.program,i.name);-1!==s&&(m[s]=i.name,this.attributeLocations.set(i,s))}this.attributeOrder=m.join("")}setBlendFunc(t,e,i,s){this.blendFunc.src=t,this.blendFunc.dst=e,this.blendFunc.srcAlpha=i,this.blendFunc.dstAlpha=s,t&&(this.transparent=!0)}setBlendEquation(t,e){this.blendEquation.modeRGB=t,this.blendEquation.modeAlpha=e}applyState(){this.depthTest?this.gl.renderer.enable(this.gl.DEPTH_TEST):this.gl.renderer.disable(this.gl.DEPTH_TEST),this.cullFace?this.gl.renderer.enable(this.gl.CULL_FACE):this.gl.renderer.disable(this.gl.CULL_FACE),this.blendFunc.src?this.gl.renderer.enable(this.gl.BLEND):this.gl.renderer.disable(this.gl.BLEND),this.cullFace&&this.gl.renderer.setCullFace(this.cullFace),this.gl.renderer.setFrontFace(this.frontFace),this.gl.renderer.setDepthMask(this.depthWrite),this.gl.renderer.setDepthFunc(this.depthFunc),this.blendFunc.src&&this.gl.renderer.setBlendFunc(this.blendFunc.src,this.blendFunc.dst,this.blendFunc.srcAlpha,this.blendFunc.dstAlpha),this.gl.renderer.setBlendEquation(this.blendEquation.modeRGB,this.blendEquation.modeAlpha)}use({flipFaces:t=!1}={}){let e=-1;this.gl.renderer.state.currentProgram===this.id||(this.gl.useProgram(this.program),this.gl.renderer.state.currentProgram=this.id),this.uniformLocations.forEach(((t,i)=>{let s=i.uniformName,r=this.uniforms[s];if(i.isStruct&&(r=r[i.structProperty],s+=`.${i.structProperty}`),i.isStructArray&&(r=r[i.structIndex][i.structProperty],s+=`[${i.structIndex}].${i.structProperty}`),!r)return dt(`Active uniform ${s} has not been supplied`);if(r&&void 0===r.value)return dt(`${s} uniform is missing a value parameter`);if(r.value.texture)return e+=1,r.value.update(e),lt(this.gl,i.type,t,e);if(r.value.length&&r.value[0].texture){const s=[];return r.value.forEach((t=>{e+=1,t.update(e),s.push(e)})),lt(this.gl,i.type,t,s)}lt(this.gl,i.type,t,r.value)})),this.applyState(),t&&this.gl.renderer.setFrontFace(this.frontFace===this.gl.CCW?this.gl.CW:this.gl.CCW)}remove(){this.gl.deleteProgram(this.program)}}function lt(t,e,i,s){s=s.length?function(t){const e=t.length,i=t[0].length;if(void 0===i)return t;const s=e*i;let r=ht[s];r||(ht[s]=r=new Float32Array(s));for(let s=0;s<e;s++)r.set(t[s],s*i);return r}(s):s;const r=t.renderer.state.uniformLocations.get(i);if(s.length)if(void 0===r||r.length!==s.length)t.renderer.state.uniformLocations.set(i,s.slice(0));else{if(function(t,e){if(t.length!==e.length)return!1;for(let i=0,s=t.length;i<s;i++)if(t[i]!==e[i])return!1;return!0}(r,s))return;r.set?r.set(s):function(t,e){for(let i=0,s=t.length;i<s;i++)t[i]=e[i]}(r,s),t.renderer.state.uniformLocations.set(i,r)}else{if(r===s)return;t.renderer.state.uniformLocations.set(i,s)}switch(e){case 5126:return s.length?t.uniform1fv(i,s):t.uniform1f(i,s);case 35664:return t.uniform2fv(i,s);case 35665:return t.uniform3fv(i,s);case 35666:return t.uniform4fv(i,s);case 35670:case 5124:case 35678:case 35680:return s.length?t.uniform1iv(i,s):t.uniform1i(i,s);case 35671:case 35667:return t.uniform2iv(i,s);case 35672:case 35668:return t.uniform3iv(i,s);case 35673:case 35669:return t.uniform4iv(i,s);case 35674:return t.uniformMatrix2fv(i,!1,s);case 35675:return t.uniformMatrix3fv(i,!1,s);case 35676:return t.uniformMatrix4fv(i,!1,s)}}function ut(t){let e=t.split("\n");for(let t=0;t<e.length;t++)e[t]=t+1+": "+e[t];return e.join("\n")}let ct=0;function dt(t){ct>100||(console.warn(t),ct++,ct>100&&console.warn("More than 100 program warnings - stopping logs."))}function mt(t){return new ot(t,{vertex:"\n    precision highp float;\n    precision highp int;\n\n    attribute vec3 position;\n    attribute vec3 normal;\n\n    uniform mat3 normalMatrix;\n    uniform mat4 modelViewMatrix;\n    uniform mat4 projectionMatrix;\n\n    varying vec3 vNormal;\n\n    void main() {\n        vNormal = normalize(normalMatrix * normal);\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n",fragment:"\n    precision highp float;\n    precision highp int;\n\n    varying vec3 vNormal;\n\n    void main() {\n        gl_FragColor.rgb = normalize(vNormal);\n        gl_FragColor.a = 1.0;\n    }\n",cullFace:null})}class pt extends Array{constructor(t=0,e=t,i=t,s=t){return super(t,e,i,s),this}get x(){return this[0]}get y(){return this[1]}get z(){return this[2]}get w(){return this[3]}set x(t){this[0]=t}set y(t){this[1]=t}set z(t){this[2]=t}set w(t){this[3]=t}set(t,e=t,i=t,s=t){return t.length?this.copy(t):(d(this,t,e,i,s),this)}copy(t){return c(this,t),this}normalize(){return p(this,this),this}multiply(t){return m(this,this,t),this}dot(t){return g(this,t)}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this[2]=t[e+2],this[3]=t[e+3],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t[e+2]=this[2],t[e+3]=this[3],t}}class gt extends W{constructor(...t){super(...t),this.frustumCulled=!1,this.isInstancedMesh=!0}addFrustumCull(){this.instanceTransforms=null,this.instanceLightmapScaleOffset=null,this.totalInstanceCount=0,this.frustumCullFunction=null,this.instanceRenderList=null,this.geometry.attributes.instanceMatrix||console.error(`mesh ${this.name?`"${this.name}" `:""}missing instanceMatrix attribute; unable to frustum cull`);const t=this.geometry.attributes.instanceMatrix.data;this.instanceTransforms=[];for(let e=0,i=0;e<t.length;e+=16,i++){const s=new R;s.index=i,s.matrix.fromArray(t,e),s.decompose(),this.instanceTransforms.push(s),s.setParent(this.parent)}if(this.totalInstanceCount=this.instanceTransforms.length,this.geometry.attributes.lightmapScaleOffset){const t=this.geometry.attributes.lightmapScaleOffset.data;for(let e=0,i=0;e<t.length;e+=4,i++)this.instanceTransforms[i].lightmapData=(new pt).fromArray(t,e)}this.frustumCullFunction=({camera:t})=>{this.instanceRenderList=[],this.instanceTransforms.forEach((e=>{t.frustumIntersectsMesh(this,e.worldMatrix)&&this.instanceRenderList.push(e)})),this.instanceRenderList.forEach(((t,e)=>{t.matrix.toArray(this.geometry.attributes.instanceMatrix.data,16*e),t.lightmapData&&(t.lightmapData.toArray(this.geometry.attributes.lightmapScaleOffset.data,4*e),this.geometry.attributes.lightmapScaleOffset.needsUpdate=!0)})),this.geometry.instancedCount=this.instanceRenderList.length,this.geometry.attributes.instanceMatrix.needsUpdate=!0},this.onBeforeRender(this.frustumCullFunction)}removeFrustumCull(){this.offBeforeRender(this.frustumCullFunction),this.geometry.instancedCount=this.totalInstanceCount,this.instanceTransforms.forEach(((t,e)=>{t.matrix.toArray(this.geometry.attributes.instanceMatrix.data,16*e),t.lightmapData&&(t.lightmapData.toArray(this.geometry.attributes.lightmapScaleOffset.data,4*e),this.geometry.attributes.lightmapScaleOffset.needsUpdate=!0)})),this.geometry.attributes.instanceMatrix.needsUpdate=!0}}const ft={5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array,"image/jpeg":Uint8Array,"image/png":Uint8Array},xt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},yt={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},bt={translation:"position",rotation:"quaternion",scale:"scale"};class wt{static setBasisManager(t){this.basisManager=t}static async load(t,e){const i=e.split("/").slice(0,-1).join("/")+"/",s=await this.parseDesc(e);return await this.parse(t,s,i)}static async parse(t,e,i){(void 0===e.asset||e.asset.version[0]<2)&&console.warn("Only GLTF >=2.0 supported. Attempting to parse."),e.extensionsRequired?.includes("KHR_texture_basisu")&&!this.basisManager&&console.warn("KHR_texture_basisu extension required but no manager supplied. Use .setBasisManager()");const s=await this.loadBuffers(e,i);t.renderer.bindVertexArray(null);const r=this.parseBufferViews(t,e,s),n=await this.parseImages(t,e,i,r),a=this.parseTextures(t,e,n),h=this.parseMaterials(t,e,a),o=this.parseSkins(t,e,r),l=this.parseMeshes(t,e,r,h,o),u=this.parseNodes(t,e,l,o,n);this.populateSkins(o,u);const c=this.parseAnimations(t,e,u,r),d=this.parseScenes(e,u),m=d[e.scene],p=this.parseLights(t,e,u,d);for(let t=u.length;t>=0;t--)u[t]||u.splice(t,1);return{json:e,buffers:s,bufferViews:r,images:n,textures:a,materials:h,meshes:l,nodes:u,lights:p,animations:c,scenes:d,scene:m}}static async parseDesc(t){return t.match(/\.glb/)?await fetch(t).then((t=>t.arrayBuffer())).then((t=>this.unpackGLB(t))):await fetch(t).then((t=>t.json()))}static unpackGLB(t){const e=new Uint32Array(t,0,3);if(1179937895!==e[0])throw new Error("Invalid glTF asset.");if(2!==e[1])throw new Error(`Unsupported glTF binary version, "${e[1]}".`);const i=new Uint32Array(t,12,2),s=i[0];if(1313821514!==i[1])throw new Error("Unexpected GLB layout.");const r=(new TextDecoder).decode(t.slice(20,20+s)),n=JSON.parse(r);if(20+s===t.byteLength)return n;const a=new Uint32Array(t,20+s,2);if(5130562!==a[1])throw new Error("Unexpected GLB layout.");const h=20+s+8,o=a[0],l=t.slice(h,h+o);return n.buffers[0].binary=l,n}static resolveURI(t,e){return"string"!=typeof t||""===t?"":(/^https?:\/\//i.test(e)&&/^\//.test(t)&&(e=e.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(t)||/^data:.*,.*$/i.test(t)||/^blob:.*$/i.test(t)?t:e+t)}static async loadBuffers(t,e){return t.buffers?await Promise.all(t.buffers.map((t=>{if(t.binary)return t.binary;const i=this.resolveURI(t.uri,e);return fetch(i).then((t=>t.arrayBuffer()))}))):null}static parseBufferViews(t,e,i){if(!e.bufferViews)return null;const s=e.bufferViews.map((t=>Object.assign({},t)));return e.meshes&&e.meshes.forEach((({primitives:i})=>{i.forEach((({attributes:i,indices:r})=>{for(let t in i)s[e.accessors[i[t]].bufferView].isAttribute=!0;void 0!==r&&(s[e.accessors[r].bufferView].isAttribute=!0,s[e.accessors[r].bufferView].target=t.ELEMENT_ARRAY_BUFFER)}))})),e.accessors.forEach((({bufferView:t,componentType:e})=>{s[t].componentType=e})),e.images&&e.images.forEach((({uri:t,bufferView:e,mimeType:i})=>{void 0!==e&&(s[e].mimeType=i)})),s.forEach((({buffer:e,byteOffset:r=0,byteLength:n,byteStride:a,target:h=t.ARRAY_BUFFER,name:o,extensions:l,extras:u,componentType:c,mimeType:d,isAttribute:m},p)=>{if(s[p].data=i[e].slice(r,r+n),!m)return;const g=t.createBuffer();t.bindBuffer(h,g),t.renderer.state.boundBuffer=g,t.bufferData(h,s[p].data,t.STATIC_DRAW),s[p].buffer=g})),s}static async parseImages(t,e,i,s){return e.images?await Promise.all(e.images.map((async({uri:t,bufferView:e,mimeType:r,name:n})=>{if("image/ktx2"===r){const{data:t}=s[e];return await this.basisManager.parseTexture(t)}const a=new Image;if(a.name=n,t)a.src=this.resolveURI(t,i);else if(void 0!==e){const{data:t}=s[e],i=new Blob([t],{type:r});a.src=URL.createObjectURL(i)}return a.ready=new Promise((t=>{a.onload=()=>t()})),a}))):null}static parseTextures(t,e,i){return e.textures?e.textures.map((s=>this.createTexture(t,e,i,s))):null}static createTexture(t,e,i,{sampler:s,source:r,name:n,extensions:a,extras:h}){void 0===r&&a&&a.KHR_texture_basisu&&(r=a.KHR_texture_basisu.source);const o=i[r];if(o.texture)return o.texture;const l={flipY:!1,wrapS:t.REPEAT,wrapT:t.REPEAT},u=void 0!==s?e.samplers[s]:null;if(u&&["magFilter","minFilter","wrapS","wrapT"].forEach((t=>{u[t]&&(l[t]=u[t])})),o.isBasis){l.image=o,l.internalFormat=o.internalFormat,o.isCompressedTexture&&(l.generateMipmaps=!1,o.length>1&&(this.minFilter=t.NEAREST_MIPMAP_LINEAR));const e=new q(t,l);return e.name=n,o.texture=e,e}const c=new q(t,l);return c.name=n,o.texture=c,o.ready.then((()=>{c.image=o})),c}static parseMaterials(t,e,i){return e.materials?e.materials.map((({name:t,extensions:e,extras:s,pbrMetallicRoughness:r={},normalTexture:n,occlusionTexture:a,emissiveTexture:h,emissiveFactor:o=[0,0,0],alphaMode:l="OPAQUE",alphaCutoff:u=.5,doubleSided:c=!1})=>{const{baseColorFactor:d=[1,1,1,1],baseColorTexture:m,metallicFactor:p=1,roughnessFactor:g=1,metallicRoughnessTexture:f}=r;return m&&(m.texture=i[m.index]),n&&(n.texture=i[n.index]),f&&(f.texture=i[f.index]),a&&(a.texture=i[a.index]),h&&(h.texture=i[h.index]),{name:t,extensions:e,extras:s,baseColorFactor:d,baseColorTexture:m,metallicFactor:p,roughnessFactor:g,metallicRoughnessTexture:f,normalTexture:n,occlusionTexture:a,emissiveTexture:h,emissiveFactor:o,alphaMode:l,alphaCutoff:u,doubleSided:c}})):null}static parseSkins(t,e,i){return e.skins?e.skins.map((({inverseBindMatrices:t,skeleton:s,joints:r})=>({inverseBindMatrices:this.parseAccessor(t,e,i),skeleton:s,joints:r}))):null}static parseMeshes(t,e,i,s,r){return e.meshes?e.meshes.map((({primitives:n,weights:a,name:h,extensions:o,extras:l},u)=>{let c=0,d=[],m=!1;return e.nodes&&e.nodes.forEach((({mesh:t,skin:e,extras:i})=>{t===u&&(c++,void 0!==e&&d.push(e),i&&i.lightmap_scale_offset&&(m=!0))})),!!d.length?((n=d.map((a=>this.parsePrimitives(t,n,e,i,s,1,m).map((({geometry:e,program:i,mode:s})=>{const n=new nt(t,{skeleton:r[a],geometry:e,program:i,mode:s});return n.name=h,n.frustumCulled=!1,n}))))).instanceCount=0,n.numInstances=c):n=this.parsePrimitives(t,n,e,i,s,c,m).map((({geometry:e,program:i,mode:s})=>{const r=new(e.attributes.instanceMatrix?gt:W)(t,{geometry:e,program:i,mode:s});return r.name=h,r.numInstances=c,r})),{primitives:n,weights:a,name:h}})):null}static parsePrimitives(t,e,i,s,r,n,a){return e.map((({attributes:e,indices:h,material:o,mode:l=4,targets:u,extensions:c,extras:d})=>{const m=new mt(t);void 0!==o&&(m.gltfMaterial=r[o]);const p=new D(t);for(let t in e)p.addAttribute(yt[t],this.parseAccessor(e[t],i,s));return void 0!==h&&p.addAttribute("index",this.parseAccessor(h,i,s)),n>1&&p.addAttribute("instanceMatrix",{instanced:1,size:16,data:new Float32Array(16*n)}),a&&p.addAttribute("lightmapScaleOffset",{instanced:1,size:4,data:new Float32Array(4*n)}),{geometry:p,program:m,mode:l}}))}static parseAccessor(t,e,i){const{bufferView:s,byteOffset:r=0,componentType:n,normalized:a=!1,count:h,type:o,min:l,max:u,sparse:c}=e.accessors[t],{data:d,buffer:m,byteOffset:p=0,byteStride:g=0,target:f}=i[s],x=xt[o],y=ft[n],b=g/y.BYTES_PER_ELEMENT;let w;if(!!g&&b!==x){const t=new y(d,r);w=new y(h*x);for(let e=0;e<h;e++){const i=b*e,s=i+x;w.set(t.slice(i,s),e*x)}}else w=new y(d,r,h*x);return{data:w,size:x,type:n,normalized:a,buffer:m,stride:g,offset:r,count:h,min:l,max:u}}static parseNodes(t,e,i,s,r){if(!e.nodes)return null;const n=e.nodes.map((({camera:s,children:n,skin:a,matrix:h,mesh:o,rotation:l,scale:u,translation:c,weights:d,name:m,extensions:p,extras:g})=>{const f=new R;m&&(f.name=m),f.extras=g,f.extensions=p,g&&void 0!==g.lightmapTexture&&(g.lightmapTexture.texture=this.createTexture(t,e,r,{source:g.lightmapTexture.index})),h?(f.matrix.copy(h),f.decompose()):(l&&f.quaternion.copy(l),u&&f.scale.copy(u),c&&f.position.copy(c),f.updateMatrix());let x=!1,y=!0,b=!1;if(void 0!==o&&(void 0!==a?(i[o].primitives[i[o].primitives.instanceCount].forEach((t=>{t.extras=g,t.setParent(f)})),i[o].primitives.instanceCount++,i[o].primitives.instanceCount===i[o].primitives.numInstances&&(delete i[o].primitives.numInstances,delete i[o].primitives.instanceCount)):i[o].primitives.forEach((t=>{t.extras=g,t.geometry.isInstanced&&(x=!0,t.instanceCount?y=!1:t.instanceCount=0,t.geometry.attributes.instanceMatrix&&(b=!0,f.matrix.toArray(t.geometry.attributes.instanceMatrix.data,16*t.instanceCount)),t.geometry.attributes.lightmapScaleOffset&&t.geometry.attributes.lightmapScaleOffset.data.set(g.lightmap_scale_offset,4*t.instanceCount),t.instanceCount++,t.instanceCount===t.numInstances&&(delete t.numInstances,delete t.instanceCount,t.geometry.attributes.instanceMatrix&&(t.geometry.attributes.instanceMatrix.needsUpdate=!0),t.geometry.attributes.lightmapScaleOffset&&(t.geometry.attributes.lightmapScaleOffset.needsUpdate=!0))),x?y&&t.setParent(f):t.setParent(f)}))),b){if(!y)return null;f.matrix.identity(),f.decompose()}return f}));return e.nodes.forEach((({children:t=[]},e)=>{t.forEach((t=>{n[t]&&n[t].setParent(n[e])}))})),i.forEach((({primitives:t},e)=>{t.forEach(((t,e)=>{t.isInstancedMesh&&t.addFrustumCull()}))})),n}static populateSkins(t,e){t&&t.forEach((t=>{t.joints=t.joints.map(((i,s)=>{const r=e[i];return r.skin=t,r.bindInverse=new F(...t.inverseBindMatrices.data.slice(16*s,16*(s+1))),r})),t.skeleton&&(t.skeleton=e[t.skeleton])}))}static parseAnimations(t,e,i,s){return e.animations?e.animations.map((({channels:t,samplers:r,name:n},a)=>{const h=t.map((({sampler:t,target:n})=>{const{input:h,interpolation:o="LINEAR",output:l}=r[t],{node:u,path:c}=n,d=i[u],m=bt[c],p=this.parseAccessor(h,e,s).data,g=this.parseAccessor(l,e,s).data;return d.animations||(d.animations=[]),d.animations.includes(a)||d.animations.push(a),{node:d,transform:m,interpolation:o,times:p,values:g}}));return{name:n,animation:new it(h)}})):null}static parseScenes(t,e){return t.scenes?t.scenes.map((({nodes:t=[],name:i,extensions:s,extras:r})=>{const n=t.reduce(((t,i)=>(e[i]&&t.push(e[i]),t)),[]);return n.extras=r,n})):null}static parseLights(t,e,i,s){const r={directional:[],point:[],spot:[]};s.forEach((t=>t.forEach((t=>t.updateMatrixWorld()))));const n=e.extensions?.KHR_lights_punctual?.lights||[];return i.forEach((t=>{if(!t?.extensions?.KHR_lights_punctual)return;const e=t.extensions.KHR_lights_punctual.light,i=n[e],s={name:i.name||"",color:{value:(new u).set(i.color||1)}};switch(void 0!==i.intensity&&s.color.value.multiply(i.intensity),i.type){case"directional":s.direction={value:new u(0,0,1).transformDirection(t.worldMatrix)};break;case"point":s.position={value:(new u).applyMatrix4(t.worldMatrix)},s.distance={value:i.range},s.decay={value:2};break;case"spot":Object.assign(s,i)}r[i.type].push(s)})),r}}function vt(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t}function Mt(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t}function At(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t}function Et(t){var e=t[0],i=t[1];return Math.sqrt(e*e+i*i)}function Tt(t,e){return t[0]*e[1]-t[1]*e[0]}class _t extends Array{constructor(t=0,e=t){return super(t,e),this}get x(){return this[0]}get y(){return this[1]}set x(t){this[0]=t}set y(t){this[1]=t}set(t,e=t){return t.length?this.copy(t):(function(t,e,i){t[0]=e,t[1]=i}(this,t,e),this)}copy(t){var e,i;return i=t,(e=this)[0]=i[0],e[1]=i[1],this}add(t,e){return e?vt(this,t,e):vt(this,this,t),this}sub(t,e){return e?Mt(this,t,e):Mt(this,this,t),this}multiply(t){var e,i,s;return t.length?(i=this,s=t,(e=this)[0]=i[0]*s[0],e[1]=i[1]*s[1]):At(this,this,t),this}divide(t){var e,i,s;return t.length?(i=this,s=t,(e=this)[0]=i[0]/s[0],e[1]=i[1]/s[1]):At(this,this,1/t),this}inverse(t=this){var e,i;return i=t,(e=this)[0]=1/i[0],e[1]=1/i[1],this}len(){return Et(this)}distance(t){return t?(e=this,s=(i=t)[0]-e[0],r=i[1]-e[1],Math.sqrt(s*s+r*r)):Et(this);var e,i,s,r}squaredLen(){return this.squaredDistance()}squaredDistance(t){return t?(e=this,s=(i=t)[0]-e[0],r=i[1]-e[1],s*s+r*r):function(t){var e=t[0],i=t[1];return e*e+i*i}(this);var e,i,s,r}negate(t=this){var e,i;return i=t,(e=this)[0]=-i[0],e[1]=-i[1],this}cross(t,e){return e?Tt(t,e):Tt(this,t)}scale(t){return At(this,this,t),this}normalize(){var t,e,i,s,r;return t=this,i=(e=this)[0],s=e[1],(r=i*i+s*s)>0&&(r=1/Math.sqrt(r)),t[0]=e[0]*r,t[1]=e[1]*r,this}dot(t){return i=t,(e=this)[0]*i[0]+e[1]*i[1];var e,i}equals(t){return i=t,(e=this)[0]===i[0]&&e[1]===i[1];var e,i}applyMatrix3(t){var e,i,s,r,n;return e=this,s=t,r=(i=this)[0],n=i[1],e[0]=s[0]*r+s[3]*n+s[6],e[1]=s[1]*r+s[4]*n+s[7],this}applyMatrix4(t){return function(t,e,i){let s=e[0],r=e[1];t[0]=i[0]*s+i[4]*r+i[12],t[1]=i[1]*s+i[5]*r+i[13]}(this,this,t),this}lerp(t,e){return function(t,e,i,s){var r=e[0],n=e[1];t[0]=r+s*(i[0]-r),t[1]=n+s*(i[1]-n)}(this,this,t,e),this}clone(){return new _t(this[0],this[1])}fromArray(t,e=0){return this[0]=t[e],this[1]=t[e+1],this}toArray(t=[],e=0){return t[e]=this[0],t[e+1]=this[1],t}}const Ft={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,DOLLY_PAN:3},St=new u,Ct=new _t,Rt=new _t;function Ot(t,{element:e=document,enabled:i=!0,target:s=new u,ease:r=.25,inertia:n=.85,enableRotate:a=!0,rotateSpeed:h=.1,autoRotate:o=!1,autoRotateSpeed:l=1,enableZoom:c=!0,zoomSpeed:d=1,zoomStyle:m="dolly",enablePan:p=!0,panSpeed:g=.1,minPolarAngle:f=0,maxPolarAngle:x=Math.PI,minAzimuthAngle:y=-1/0,maxAzimuthAngle:b=1/0,minDistance:w=0,maxDistance:v=1/0}={}){this.enabled=i,this.target=s,this.zoomStyle=m,r=r||1,n=n||0,this.minDistance=w,this.maxDistance=v;const M={radius:1,phi:0,theta:0},A={radius:1,phi:0,theta:0},E={radius:1,phi:0,theta:0},T=new u,_=new u;_.copy(t.position).sub(this.target),E.radius=A.radius=_.distance(),E.theta=A.theta=Math.atan2(_.x,_.z),E.phi=A.phi=Math.acos(Math.min(Math.max(_.y/A.radius,-1),1)),this.offset=_,this.update=()=>{o&&function(){const t=2*Math.PI/60/60*l;M.theta-=t}(),A.radius*=M.radius,A.theta+=M.theta,A.phi+=M.phi,A.theta=Math.max(y,Math.min(b,A.theta)),A.phi=Math.max(f,Math.min(x,A.phi)),A.radius=Math.max(this.minDistance,Math.min(this.maxDistance,A.radius)),E.phi+=(A.phi-E.phi)*r,E.theta+=(A.theta-E.theta)*r,E.radius+=(A.radius-E.radius)*r,this.target.add(T);let e=E.radius*Math.sin(Math.max(1e-6,E.phi));_.x=e*Math.sin(E.theta),_.y=E.radius*Math.cos(E.phi),_.z=e*Math.cos(E.theta),t.position.copy(this.target).add(_),t.lookAt(this.target),M.theta*=n,M.phi*=n,T.multiply(n),M.radius=1},this.forcePosition=()=>{_.copy(t.position).sub(this.target),E.radius=A.radius=_.distance(),E.theta=A.theta=Math.atan2(_.x,_.z),E.phi=A.phi=Math.acos(Math.min(Math.max(_.y/A.radius,-1),1)),t.lookAt(this.target)};const F=new _t,S=new _t,C=new _t;let R=Ft.NONE;function O(){return Math.pow(.95,d)}this.mouseButtons={ORBIT:0,ZOOM:1,PAN:2};const L=(i,s)=>{let r=e===document?document.body:e;St.copy(t.position).sub(this.target);let n=St.distance();var a,h;n*=Math.tan((t.fov||45)/2*Math.PI/180),a=2*i*n/r.clientHeight,h=t.matrix,St.set(h[0],h[1],h[2]),St.multiply(-a),T.add(St),function(t,e){St.set(e[4],e[5],e[6]),St.multiply(t),T.add(St)}(2*s*n/r.clientHeight,t.matrix)},P=e=>{"dolly"===this.zoomStyle?M.radius/=e:(t.fov/=e,"orthographic"===t.type?t.orthographic():t.perspective())};function N(t,i){Ct.set(t,i),Rt.sub(Ct,F).multiply(h);let s=e===document?document.body:e;M.theta-=2*Math.PI*Rt.x/s.clientHeight,M.phi-=2*Math.PI*Rt.y/s.clientHeight,F.copy(Ct)}function B(t,e){Ct.set(t,e),Rt.sub(Ct,S).multiply(g),L(Rt.x,Rt.y),S.copy(Ct)}const I=t=>{if(this.enabled){switch(t.button){case this.mouseButtons.ORBIT:if(!1===a)return;F.set(t.clientX,t.clientY),R=Ft.ROTATE;break;case this.mouseButtons.ZOOM:if(!1===c)return;C.set(t.clientX,t.clientY),R=Ft.DOLLY;break;case this.mouseButtons.PAN:if(!1===p)return;S.set(t.clientX,t.clientY),R=Ft.PAN}R!==Ft.NONE&&(window.addEventListener("mousemove",U,!1),window.addEventListener("mouseup",z,!1))}},U=t=>{if(this.enabled)switch(R){case Ft.ROTATE:if(!1===a)return;N(t.clientX,t.clientY);break;case Ft.DOLLY:if(!1===c)return;!function(t){Ct.set(t.clientX,t.clientY),Rt.sub(Ct,C),Rt.y>0?P(O()):Rt.y<0&&P(1/O()),C.copy(Ct)}(t);break;case Ft.PAN:if(!1===p)return;B(t.clientX,t.clientY)}},z=()=>{window.removeEventListener("mousemove",U,!1),window.removeEventListener("mouseup",z,!1),R=Ft.NONE},D=t=>{this.enabled&&c&&(R===Ft.NONE||R===Ft.ROTATE)&&(t.stopPropagation(),t.preventDefault(),t.deltaY<0?P(1/O()):t.deltaY>0&&P(O()))},k=t=>{if(this.enabled)switch(t.preventDefault(),t.touches.length){case 1:if(!1===a)return;F.set(t.touches[0].pageX,t.touches[0].pageY),R=Ft.ROTATE;break;case 2:if(!1===c&&!1===p)return;!function(t){if(c){let e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY,s=Math.sqrt(e*e+i*i);C.set(0,s)}if(p){let e=.5*(t.touches[0].pageX+t.touches[1].pageX),i=.5*(t.touches[0].pageY+t.touches[1].pageY);S.set(e,i)}}(t),R=Ft.DOLLY_PAN;break;default:R=Ft.NONE}},V=t=>{if(this.enabled)switch(t.preventDefault(),t.stopPropagation(),t.touches.length){case 1:if(!1===a)return;N(t.touches[0].pageX,t.touches[0].pageY);break;case 2:if(!1===c&&!1===p)return;!function(t){if(c){let e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY,s=Math.sqrt(e*e+i*i);Ct.set(0,s),Rt.set(0,Math.pow(Ct.y/C.y,d)),P(Rt.y),C.copy(Ct)}p&&B(.5*(t.touches[0].pageX+t.touches[1].pageX),.5*(t.touches[0].pageY+t.touches[1].pageY))}(t);break;default:R=Ft.NONE}},j=()=>{this.enabled&&(R=Ft.NONE)},q=t=>{this.enabled&&t.preventDefault()};this.remove=function(){e.removeEventListener("contextmenu",q),e.removeEventListener("mousedown",I),e.removeEventListener("wheel",D),e.removeEventListener("touchstart",k),e.removeEventListener("touchend",j),e.removeEventListener("touchmove",V),window.removeEventListener("mousemove",U),window.removeEventListener("mouseup",z)},e.addEventListener("contextmenu",q,!1),e.addEventListener("mousedown",I,!1),e.addEventListener("wheel",D,{passive:!1}),e.addEventListener("touchstart",k,{passive:!1}),e.addEventListener("touchend",j,!1),e.addEventListener("touchmove",V,{passive:!1})}const Lt=new _t,Pt=new _t,Nt=new _t,Bt=new u,It=new u,Ut=new u,zt=new u,Dt=new u,kt=new u,Vt=new u,jt=new u,qt=new u,Xt=new u,Yt=new u,Gt=new F;class Wt{constructor(){this.origin=new u,this.direction=new u}castMouse(t,e=[0,0]){if("orthographic"===t.type){const{left:i,right:s,bottom:r,top:n,zoom:a}=t,h=i/a+(s-i)/a*(.5*e[0]+.5),o=r/a+(n-r)/a*(.5*e[1]+.5);this.origin.set(h,o,0),this.origin.applyMatrix4(t.worldMatrix),this.direction.x=-t.worldMatrix[8],this.direction.y=-t.worldMatrix[9],this.direction.z=-t.worldMatrix[10]}else t.worldMatrix.getTranslation(this.origin),this.direction.set(e[0],e[1],.5),t.unproject(this.direction),this.direction.sub(this.origin).normalize()}intersectBounds(t,{maxDistance:e,output:i=[]}={}){Array.isArray(t)||(t=[t]);const s=Gt,r=Bt,n=It,a=i;return a.length=0,t.forEach((t=>{t.geometry.bounds&&t.geometry.bounds.radius!==1/0||t.geometry.computeBoundingSphere();const i=t.geometry.bounds;let h;if(s.inverse(t.worldMatrix),e&&(n.copy(this.direction).scaleRotateMatrix4(s),h=e*n.len()),r.copy(this.origin).applyMatrix4(s),n.copy(this.direction).transformDirection(s),e&&r.distance(i.center)-i.radius>h)return;let o=0;if("sphere"===t.geometry.raycast){if(r.distance(i.center)>i.radius&&(o=this.intersectSphere(i,r,n),!o))return}else if((r.x<i.min.x||r.x>i.max.x||r.y<i.min.y||r.y>i.max.y||r.z<i.min.z||r.z>i.max.z)&&(o=this.intersectBox(i,r,n),!o))return;e&&o>h||(t.hit||(t.hit={localPoint:new u,point:new u}),t.hit.localPoint.copy(n).multiply(o).add(r),t.hit.point.copy(t.hit.localPoint).applyMatrix4(t.worldMatrix),t.hit.distance=t.hit.point.distance(this.origin),a.push(t))})),a.sort(((t,e)=>t.hit.distance-e.hit.distance)),a}intersectMeshes(t,{cullFace:e=!0,maxDistance:i,includeUV:s=!0,includeNormal:r=!0,output:n=[]}={}){const a=this.intersectBounds(t,{maxDistance:i,output:n});if(!a.length)return a;const h=Gt,o=Bt,l=It,c=Ut,d=zt,m=Dt,p=kt,g=Vt,f=jt,x=Lt,y=Pt,b=Nt;for(let t=a.length-1;t>=0;t--){const n=a[t];let w;h.inverse(n.worldMatrix),i&&(l.copy(this.direction).scaleRotateMatrix4(h),w=i*l.len()),o.copy(this.origin).applyMatrix4(h),l.copy(this.direction).transformDirection(h);let v,M,A,E=0;const T=n.geometry,_=T.attributes,F=_.index,S=_.position,C=Math.max(0,T.drawRange.start),R=Math.min(F?F.count:S.count,T.drawRange.start+T.drawRange.count),O=S.size;for(let t=C;t<R;t+=3){const s=F?F.data[t]:t,r=F?F.data[t+1]:t+1,n=F?F.data[t+2]:t+2;c.fromArray(S.data,s*O),d.fromArray(S.data,r*O),m.fromArray(S.data,n*O);const a=this.intersectTriangle(c,d,m,e,o,l,g);a&&(i&&a>w||(!E||a<E)&&(E=a,v=s,M=r,A=n,p.copy(g)))}E||a.splice(t,1),n.hit.localPoint.copy(l).multiply(E).add(o),n.hit.point.copy(n.hit.localPoint).applyMatrix4(n.worldMatrix),n.hit.distance=n.hit.point.distance(this.origin),n.hit.faceNormal||(n.hit.localFaceNormal=new u,n.hit.faceNormal=new u,n.hit.uv=new _t,n.hit.localNormal=new u,n.hit.normal=new u),n.hit.localFaceNormal.copy(p),n.hit.faceNormal.copy(n.hit.localFaceNormal).transformDirection(n.worldMatrix),(s||r)&&(c.fromArray(S.data,3*v),d.fromArray(S.data,3*M),m.fromArray(S.data,3*A),this.getBarycoord(n.hit.localPoint,c,d,m,f)),s&&_.uv&&(x.fromArray(_.uv.data,2*v),y.fromArray(_.uv.data,2*M),b.fromArray(_.uv.data,2*A),n.hit.uv.set(x.x*f.x+y.x*f.y+b.x*f.z,x.y*f.x+y.y*f.y+b.y*f.z)),r&&_.normal&&(c.fromArray(_.normal.data,3*v),d.fromArray(_.normal.data,3*M),m.fromArray(_.normal.data,3*A),n.hit.localNormal.set(c.x*f.x+d.x*f.y+m.x*f.z,c.y*f.x+d.y*f.y+m.y*f.z,c.z*f.x+d.z*f.y+m.z*f.z),n.hit.normal.copy(n.hit.localNormal).transformDirection(n.worldMatrix))}return a.sort(((t,e)=>t.hit.distance-e.hit.distance)),a}intersectPlane(t,e=this.origin,i=this.direction){const s=Bt;s.sub(t.origin,e);const r=s.dot(t.normal),n=i.dot(t.normal);if(0==n)return 0;const a=r/n;return a<=0?0:e.add(i.scale(a))}intersectSphere(t,e=this.origin,i=this.direction){const s=Ut;s.sub(t.center,e);const r=s.dot(i),n=s.dot(s)-r*r,a=t.radius*t.radius;if(n>a)return 0;const h=Math.sqrt(a-n),o=r-h,l=r+h;return o<0&&l<0?0:o<0?l:o}intersectBox(t,e=this.origin,i=this.direction){let s,r,n,a,h,o;const l=1/i.x,u=1/i.y,c=1/i.z,d=t.min,m=t.max;return s=((l>=0?d.x:m.x)-e.x)*l,r=((l>=0?m.x:d.x)-e.x)*l,n=((u>=0?d.y:m.y)-e.y)*u,a=((u>=0?m.y:d.y)-e.y)*u,s>a||n>r?0:(n>s&&(s=n),a<r&&(r=a),h=((c>=0?d.z:m.z)-e.z)*c,o=((c>=0?m.z:d.z)-e.z)*c,s>o||h>r?0:(h>s&&(s=h),o<r&&(r=o),r<0?0:s>=0?s:r))}intersectTriangle(t,e,i,s=!0,r=this.origin,n=this.direction,a=Vt){const h=jt,o=qt,l=Xt;h.sub(e,t),o.sub(i,t),a.cross(h,o);let u,c=n.dot(a);if(!c)return 0;if(c>0){if(s)return 0;u=1}else u=-1,c=-c;l.sub(r,t);let d=u*n.dot(o.cross(l,o));if(d<0)return 0;let m=u*n.dot(h.cross(l));if(m<0)return 0;if(d+m>c)return 0;let p=-u*l.dot(a);return p<0?0:p/c}getBarycoord(t,e,i,s,r=jt){const n=qt,a=Xt,h=Yt;n.sub(s,e),a.sub(i,e),h.sub(t,e);const o=n.dot(n),l=n.dot(a),u=n.dot(h),c=a.dot(a),d=a.dot(h),m=o*c-l*l;if(0===m)return r.set(-2,-1,-1);const p=1/m,g=(c*u-l*d)*p,f=(o*d-l*u)*p;return r.set(1-g-f,f,g)}}const Ht=new u;let Zt=1;class $t{constructor({canvas:t=document.createElement("canvas"),width:e=300,height:i=150,dpr:s=1,alpha:r=!1,depth:n=!0,stencil:a=!1,antialias:h=!1,premultipliedAlpha:o=!1,preserveDrawingBuffer:l=!1,powerPreference:u="default",autoClear:c=!0,webgl:d=2}={}){const m={alpha:r,depth:n,stencil:a,antialias:h,premultipliedAlpha:o,preserveDrawingBuffer:l,powerPreference:u};this.dpr=s,this.alpha=r,this.color=!0,this.depth=n,this.stencil=a,this.premultipliedAlpha=o,this.autoClear=c,this.id=Zt++,2===d&&(this.gl=t.getContext("webgl2",m)),this.isWebgl2=!!this.gl,this.gl||(this.gl=t.getContext("webgl",m)),this.gl||console.error("unable to create webgl context"),this.gl.renderer=this,this.setSize(e,i),this.state={},this.state.blendFunc={src:this.gl.ONE,dst:this.gl.ZERO},this.state.blendEquation={modeRGB:this.gl.FUNC_ADD},this.state.cullFace=null,this.state.frontFace=this.gl.CCW,this.state.depthMask=!0,this.state.depthFunc=this.gl.LESS,this.state.premultiplyAlpha=!1,this.state.flipY=!1,this.state.unpackAlignment=4,this.state.framebuffer=null,this.state.viewport={x:0,y:0,width:null,height:null},this.state.textureUnits=[],this.state.activeTextureUnit=0,this.state.boundBuffer=null,this.state.uniformLocations=new Map,this.state.currentProgram=null,this.extensions={},this.isWebgl2?(this.getExtension("EXT_color_buffer_float"),this.getExtension("OES_texture_float_linear")):(this.getExtension("OES_texture_float"),this.getExtension("OES_texture_float_linear"),this.getExtension("OES_texture_half_float"),this.getExtension("OES_texture_half_float_linear"),this.getExtension("OES_element_index_uint"),this.getExtension("OES_standard_derivatives"),this.getExtension("EXT_sRGB"),this.getExtension("WEBGL_depth_texture"),this.getExtension("WEBGL_draw_buffers")),this.getExtension("WEBGL_compressed_texture_astc"),this.getExtension("EXT_texture_compression_bptc"),this.getExtension("WEBGL_compressed_texture_s3tc"),this.getExtension("WEBGL_compressed_texture_etc1"),this.getExtension("WEBGL_compressed_texture_pvrtc"),this.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),this.vertexAttribDivisor=this.getExtension("ANGLE_instanced_arrays","vertexAttribDivisor","vertexAttribDivisorANGLE"),this.drawArraysInstanced=this.getExtension("ANGLE_instanced_arrays","drawArraysInstanced","drawArraysInstancedANGLE"),this.drawElementsInstanced=this.getExtension("ANGLE_instanced_arrays","drawElementsInstanced","drawElementsInstancedANGLE"),this.createVertexArray=this.getExtension("OES_vertex_array_object","createVertexArray","createVertexArrayOES"),this.bindVertexArray=this.getExtension("OES_vertex_array_object","bindVertexArray","bindVertexArrayOES"),this.deleteVertexArray=this.getExtension("OES_vertex_array_object","deleteVertexArray","deleteVertexArrayOES"),this.drawBuffers=this.getExtension("WEBGL_draw_buffers","drawBuffers","drawBuffersWEBGL"),this.parameters={},this.parameters.maxTextureUnits=this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.parameters.maxAnisotropy=this.getExtension("EXT_texture_filter_anisotropic")?this.gl.getParameter(this.getExtension("EXT_texture_filter_anisotropic").MAX_TEXTURE_MAX_ANISOTROPY_EXT):0}setSize(t,e){this.width=t,this.height=e,this.gl.canvas.width=t*this.dpr,this.gl.canvas.height=e*this.dpr,this.gl.canvas.style&&Object.assign(this.gl.canvas.style,{width:t+"px",height:e+"px"})}setViewport(t,e,i=0,s=0){this.state.viewport.width===t&&this.state.viewport.height===e||(this.state.viewport.width=t,this.state.viewport.height=e,this.state.viewport.x=i,this.state.viewport.y=s,this.gl.viewport(i,s,t,e))}setScissor(t,e,i=0,s=0){this.gl.scissor(i,s,t,e)}enable(t){!0!==this.state[t]&&(this.gl.enable(t),this.state[t]=!0)}disable(t){!1!==this.state[t]&&(this.gl.disable(t),this.state[t]=!1)}setBlendFunc(t,e,i,s){this.state.blendFunc.src===t&&this.state.blendFunc.dst===e&&this.state.blendFunc.srcAlpha===i&&this.state.blendFunc.dstAlpha===s||(this.state.blendFunc.src=t,this.state.blendFunc.dst=e,this.state.blendFunc.srcAlpha=i,this.state.blendFunc.dstAlpha=s,void 0!==i?this.gl.blendFuncSeparate(t,e,i,s):this.gl.blendFunc(t,e))}setBlendEquation(t,e){t=t||this.gl.FUNC_ADD,this.state.blendEquation.modeRGB===t&&this.state.blendEquation.modeAlpha===e||(this.state.blendEquation.modeRGB=t,this.state.blendEquation.modeAlpha=e,void 0!==e?this.gl.blendEquationSeparate(t,e):this.gl.blendEquation(t))}setCullFace(t){this.state.cullFace!==t&&(this.state.cullFace=t,this.gl.cullFace(t))}setFrontFace(t){this.state.frontFace!==t&&(this.state.frontFace=t,this.gl.frontFace(t))}setDepthMask(t){this.state.depthMask!==t&&(this.state.depthMask=t,this.gl.depthMask(t))}setDepthFunc(t){this.state.depthFunc!==t&&(this.state.depthFunc=t,this.gl.depthFunc(t))}activeTexture(t){this.state.activeTextureUnit!==t&&(this.state.activeTextureUnit=t,this.gl.activeTexture(this.gl.TEXTURE0+t))}bindFramebuffer({target:t=this.gl.FRAMEBUFFER,buffer:e=null}={}){this.state.framebuffer!==e&&(this.state.framebuffer=e,this.gl.bindFramebuffer(t,e))}getExtension(t,e,i){return e&&this.gl[e]?this.gl[e].bind(this.gl):(this.extensions[t]||(this.extensions[t]=this.gl.getExtension(t)),e?this.extensions[t]?this.extensions[t][i].bind(this.extensions[t]):null:this.extensions[t])}sortOpaque(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program.id!==e.program.id?t.program.id-e.program.id:t.zDepth!==e.zDepth?t.zDepth-e.zDepth:e.id-t.id}sortTransparent(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.zDepth!==e.zDepth?e.zDepth-t.zDepth:e.id-t.id}sortUI(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program.id!==e.program.id?t.program.id-e.program.id:e.id-t.id}getRenderList({scene:t,camera:e,frustumCull:i,sort:s}){let r=[];if(e&&i&&e.updateFrustum(),t.traverse((t=>{if(!t.visible)return!0;t.draw&&(i&&t.frustumCulled&&e&&!e.frustumIntersectsMesh(t)||r.push(t))})),s){const t=[],i=[],s=[];r.forEach((r=>{r.program.transparent?r.program.depthTest?i.push(r):s.push(r):t.push(r),r.zDepth=0,0===r.renderOrder&&r.program.depthTest&&e&&(r.worldMatrix.getTranslation(Ht),Ht.applyMatrix4(e.projectionViewMatrix),r.zDepth=Ht.z)})),t.sort(this.sortOpaque),i.sort(this.sortTransparent),s.sort(this.sortUI),r=t.concat(i,s)}return r}render({scene:t,camera:e,target:i=null,update:s=!0,sort:r=!0,frustumCull:n=!0,clear:a}){null===i?(this.bindFramebuffer(),this.setViewport(this.width*this.dpr,this.height*this.dpr)):(this.bindFramebuffer(i),this.setViewport(i.width,i.height)),(a||this.autoClear&&!1!==a)&&(!this.depth||i&&!i.depth||(this.enable(this.gl.DEPTH_TEST),this.setDepthMask(!0)),this.gl.clear((this.color?this.gl.COLOR_BUFFER_BIT:0)|(this.depth?this.gl.DEPTH_BUFFER_BIT:0)|(this.stencil?this.gl.STENCIL_BUFFER_BIT:0))),s&&t.updateMatrixWorld(),e&&e.updateMatrixWorld();this.getRenderList({scene:t,camera:e,frustumCull:n,sort:r}).forEach((t=>{t.draw({camera:e})}))}}class Kt extends D{constructor(t,{width:e=1,height:i=1,widthSegments:s=1,heightSegments:r=1,attributes:n={}}={}){const a=s,h=r,o=(a+1)*(h+1),l=a*h*6,u=new Float32Array(3*o),c=new Float32Array(3*o),d=new Float32Array(2*o),m=l>65536?new Uint32Array(l):new Uint16Array(l);Kt.buildPlane(u,c,d,m,e,i,0,a,h),Object.assign(n,{position:{size:3,data:u},normal:{size:3,data:c},uv:{size:2,data:d},index:{data:m}}),super(t,n)}static buildPlane(t,e,i,s,r,n,a,h,o,l=0,u=1,c=2,d=1,m=-1,p=0,g=0){const f=p,x=r/h,y=n/o;for(let b=0;b<=o;b++){let w=b*y-n/2;for(let n=0;n<=h;n++,p++){let y=n*x-r/2;if(t[3*p+l]=y*d,t[3*p+u]=w*m,t[3*p+c]=a/2,e[3*p+l]=0,e[3*p+u]=0,e[3*p+c]=a>=0?1:-1,i[2*p]=n/h,i[2*p+1]=1-b/o,b===o||n===h)continue;let v=f+n+b*(h+1),M=f+n+(b+1)*(h+1),A=f+n+(b+1)*(h+1)+1,E=f+n+b*(h+1)+1;s[6*g]=v,s[6*g+1]=M,s[6*g+2]=E,s[6*g+3]=M,s[6*g+4]=A,s[6*g+5]=E,g++}}}}class Qt extends D{constructor(t,{width:e=1,height:i=1,depth:s=1,widthSegments:r=1,heightSegments:n=1,depthSegments:a=1,attributes:h={}}={}){const o=r,l=n,u=a,c=(o+1)*(l+1)*2+(o+1)*(u+1)*2+(l+1)*(u+1)*2,d=6*(o*l*2+o*u*2+l*u*2),m=new Float32Array(3*c),p=new Float32Array(3*c),g=new Float32Array(2*c),f=c>65536?new Uint32Array(d):new Uint16Array(d);let x=0,y=0;Kt.buildPlane(m,p,g,f,s,i,e,u,l,2,1,0,-1,-1,x,y),x+=(u+1)*(l+1),y+=u*l,Kt.buildPlane(m,p,g,f,s,i,-e,u,l,2,1,0,1,-1,x,y),x+=(u+1)*(l+1),y+=u*l,Kt.buildPlane(m,p,g,f,e,s,i,u,o,0,2,1,1,1,x,y),x+=(o+1)*(u+1),y+=o*u,Kt.buildPlane(m,p,g,f,e,s,-i,u,o,0,2,1,1,-1,x,y),x+=(o+1)*(u+1),y+=o*u,Kt.buildPlane(m,p,g,f,e,i,-s,o,l,0,1,2,-1,-1,x,y),x+=(o+1)*(l+1),y+=o*l,Kt.buildPlane(m,p,g,f,e,i,s,o,l,0,1,2,1,-1,x,y),Object.assign(h,{position:{size:3,data:m},normal:{size:3,data:p},uv:{size:2,data:g},index:{data:f}}),super(t,h)}}class Jt extends W{constructor(t,e){new q(t,{image:e,target:t.TEXTURE_CUBE_MAP});super(t,{geometry:new Qt(t),program:new ot(t,{vertex:"#version 300 es\n            in vec3 position;\n            out vec3 uv;\n\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n\n            void main() {\n                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                uv = position;\n            }\n            ",fragment:"#version 300 es\n            precision highp float;\n            //uniform samplerCube tMap;\n            in vec3 uv;\n            out vec4 outColor;\n\n            void main() {\n                float sky = clamp(uv.y + 0.5, 0.0, 1.0);\n                //outColor = texture(tMap, uv);\n                outColor = vec4(sky / 2.0, sky / 2.0, sky, 1.0);\n            }\n            ",cullFace:null})}),this.worldMatrix.scale(100),this.beforeRenderCallbacks=[()=>{this.program.uniforms.modelViewMatrix.value.setPosition([0,0,0])}]}updateMatrix(){}updateMatrixWorld(t){}}class te{constructor(){this.types={}}register(t,e){void 0===this.types[t]&&(this.types[t]=[]);const i=this.types[t].push(e);return()=>{delete this.types[t][i-1]}}send(t,e){if(t in this.types)for(const i of this.types[t])i(e)}}function ee(t,e,i){const s=document.createElement("li"),r=document.createElement("button");r.append(t),r.addEventListener("click",i),s.append(r),document.getElementById(e).append(s)}const ie=0,se=1,re={origin:new u(0,0,0),normal:new u(0,1,0)};class ne{constructor({msgBus:t=t,assets:e=e,raycast:i=i,scene:s=s,camera:r=r,renderer:n=n}){this.state=ie,this.heldObject=null,this.gl=n.gl,this.canvas=this.gl.canvas,this.msgBus=t,this.assets=e,this.raycast=i,this.scene=s,this.camera=r,this.renderer=n,this.mouse=new _t,this.objectList=[],this.msgBus.register("onAssetsLoaded",(()=>{this.setupAssets()})),this.registerCallbacks()}setupAssets(){for(const t in this.assets)ee(this.assets[t].name,"buttonList",(e=>{this.heldObject&&(this.heldObject=void 0),this.heldObject=new W(this.gl,this.assets[t]),this.state=se,this.heldObject.position[2]=-1e3,this.heldObject.setParent(this.scene)}));ee("Clear","buttonList",(()=>{this.heldObject&&(this.heldObject.setParent(null),this.heldObject=void 0,this.state=ie)}))}pointerDown(t){switch(this.mouse.set(t.x/this.renderer.width*2-1,2*(1-t.y/this.renderer.height)-1),this.raycast.castMouse(this.camera,this.mouse),this.state){case se:const t=this.raycast.intersectPlane(re);t&&(this.heldObject.position=t.clone()),this.state=ie,this.objectList.push(this.heldObject),this.heldObject=void 0;break;case ie:const e=this.raycast.intersectMeshes(this.objectList,{includeUV:!1,includeNormal:!1});if(e.length){this.heldObject=e[0],console.log(this.heldObject);const t=this.objectList.find((t=>t.id==e[0].id));t>-1&&this.objectList.splice(t,1),this.state=se}}}pointerMove(t){if(this.state==se){this.mouse.set(t.x/this.renderer.width*2-1,2*(1-t.y/this.renderer.height)-1),this.raycast.castMouse(this.camera,this.mouse);const e=this.raycast.intersectPlane(re);e&&(this.heldObject.position=e.clone())}}registerCallbacks(){this.canvas.addEventListener("pointerdown",(t=>this.pointerDown(t))),this.canvas.addEventListener("pointermove",(t=>this.pointerMove(t)))}unregisterCallbacks(){}}!function(){const t=document.querySelector("#renderCanvas"),e=new $t({dpr:1,canvas:t}),i=e.gl,s=new te;let r=new u(0,0,0);const n=new ot(i,{vertex:"#version 300 es\n            in vec3 position;\n            in vec4 color;\n            in vec3 normal;\n            uniform vec3 view;\n            //in vec2 uv;\n\n            uniform mat4 modelViewMatrix;\n            uniform mat4 projectionMatrix;\n            //out vec2 v_uv;\n            out vec4 vColor;\n            out vec3 vNormal;\n            out vec3 vView;\n\n            void main() {\n                vView = normalize(view);\n                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                vColor = color;\n                vNormal = normal;\n                //v_uv = uv;\n            }\n        ",fragment:"#version 300 es\n            precision highp float;\n            //in vec2 v_uv;\n            in vec4 vColor;\n            in vec3 vNormal;\n            in vec3 vView;\n            out vec4 outColor;\n            //uniform sampler2D tBaseColor;\n            void main() {\n                vec3 light = vec3(0, 1, 0);\n                vec3 normal = normalize(vNormal);\n                float t = (dot(normal, light) + 1.0) / 2.0;\n                vec3 r = 2.0 * dot(normal, light) * normal - light;\n                float s = clamp(100.0 * dot(r, vView) - 97.0, 0.0, 1.0);\n\n                vec3 cool = vec3(0.2, 0.2, 0.6) * t + t * vColor.xyz;\n                vec3 warm = vec3(0.3, 0.3, 0.0) + 0.25 * vColor.xyz;\n                vec3 highlight = vec3(1.0, 1.0, 1.0);\n                vec3 shaded = vec3(1.0, 1.0, 1.0) * s + cool * (1.0 - s);\n                //outColor = texture(tBaseColor, v_uv);\n                outColor = vec4(shaded, 1.0);\n            }\n        ",uniforms:{view:r}}),a=(new q(i),new N(i,{near:.1,far:1e4}));function h(){e.setSize(t.parentNode.clientWidth,t.parentNode.clientHeight),a.perspective({aspect:i.canvas.width/i.canvas.height})}window.addEventListener("resize",h,!1),h();const o=new Ot(a,{element:t}),l={};a.position.set(0,.5,-1).normalize().multiply(2.5).add([5,5,-5]),o.target.copy([0,2,2]),o.forcePosition();const c=new R,d=new Wt(i);new ne({msgBus:s,assets:l,raycast:d,scene:c,camera:a,renderer:e}),async function(){const t=await wt.load(i,"assets.glb");console.log(t);(t.scene||t.scenes[0]).forEach((t=>{t.traverse((t=>{if(t.geometry&&t.extras.asset_id&&(l[t.extras.asset_id]=t),t.program){t.program.gltfMaterial;t.program=n}}))}));new Jt(i).setParent(c),s.send("onAssetsLoaded")}(),requestAnimationFrame((function t(){requestAnimationFrame(t),o.update(),r.set(0,0,1),r.applyQuaternion(a.quaternion),n.uniforms.view.value=r,e.render({scene:c,camera:a,sort:!1,frustumCull:!1})}))}();
//# sourceMappingURL=index.c0dd9181.js.map
